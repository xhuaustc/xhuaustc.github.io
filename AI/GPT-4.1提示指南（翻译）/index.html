<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>GPT-4.1 提示指南（翻译） | Michael Blog</title><meta name="author" content="Michael Pan"><meta name="copyright" content="Michael Pan"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="原文 GPT-4.1 Prompting Guide GPT-4.1 模型系列在编码、指令遵循和长上下文处理能力方面相比 GPT-4o 有了显著提升。在本提示指南中，我们整理了从大量内部测试中得出的重要提示技巧，以帮助开发者充分利用这个新模型系列的改进能力。 许多典型的最佳实践仍然适用于 GPT-4.1，例如提供上下文示例、使指令尽可能具体和清晰，以及通过提示诱导规划以最大化模型智能。然而，我们预">
<meta property="og:type" content="article">
<meta property="og:title" content="GPT-4.1 提示指南（翻译）">
<meta property="og:url" content="https://xhua.eu.org/AI/GPT-4.1%E6%8F%90%E7%A4%BA%E6%8C%87%E5%8D%97%EF%BC%88%E7%BF%BB%E8%AF%91%EF%BC%89/index.html">
<meta property="og:site_name" content="Michael Blog">
<meta property="og:description" content="原文 GPT-4.1 Prompting Guide GPT-4.1 模型系列在编码、指令遵循和长上下文处理能力方面相比 GPT-4o 有了显著提升。在本提示指南中，我们整理了从大量内部测试中得出的重要提示技巧，以帮助开发者充分利用这个新模型系列的改进能力。 许多典型的最佳实践仍然适用于 GPT-4.1，例如提供上下文示例、使指令尽可能具体和清晰，以及通过提示诱导规划以最大化模型智能。然而，我们预">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xhuaustc/images@main/a5bc40e344df82a2633906aa04eb55447b0890a6c2dacf23b585537f4838f7e4.png">
<meta property="article:published_time" content="2025-07-21T09:00:00.000Z">
<meta property="article:modified_time" content="2025-09-30T11:52:34.795Z">
<meta property="article:author" content="Michael Pan">
<meta property="article:tag" content="MCP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/xhuaustc/images@main/a5bc40e344df82a2633906aa04eb55447b0890a6c2dacf23b585537f4838f7e4.png"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/xhuaustc/images@main/ee7822a9c1b896de5649988ed5a9dc89c8f46fb54dd442f2d9c74721a05fa708.png"><link rel="canonical" href="https://xhua.eu.org/AI/GPT-4.1%E6%8F%90%E7%A4%BA%E6%8C%87%E5%8D%97%EF%BC%88%E7%BF%BB%E8%AF%91%EF%BC%89/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'GPT-4.1 提示指南（翻译）',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-09-30 19:52:34'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://cdn.jsdelivr.net/gh/xhuaustc/images@main/87ab7c10242ff1ab32f46f7c7b335d0581d3885fa40b8e3dc1d97014e67ea56d.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">249</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">71</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">13</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/xhuaustc/images@main/a5bc40e344df82a2633906aa04eb55447b0890a6c2dacf23b585537f4838f7e4.png')"><nav id="nav"><span id="blog-info"><a href="/" title="Michael Blog"><span class="site-name">Michael Blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">GPT-4.1 提示指南（翻译）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-07-21T09:00:00.000Z" title="发表于 2025-07-21 17:00:00">2025-07-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-09-30T11:52:34.795Z" title="更新于 2025-09-30 19:52:34">2025-09-30</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/AI/">AI</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/AI/DevOps/">DevOps</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="GPT-4.1 提示指南（翻译）"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>原文 <a target="_blank" rel="noopener" href="https://cookbook.openai.com/examples/gpt4-1_prompting_guide#4-instruction-following">GPT-4.1 Prompting Guide</a></p>
<p>GPT-4.1 模型系列在编码、指令遵循和长上下文处理能力方面相比 GPT-4o 有了显著提升。在本提示指南中，我们整理了从大量内部测试中得出的重要提示技巧，以帮助开发者充分利用这个新模型系列的改进能力。</p>
<p>许多典型的最佳实践仍然适用于 GPT-4.1，例如提供上下文示例、使指令尽可能具体和清晰，以及通过提示诱导规划以最大化模型智能。然而，我们预计充分利用这个模型需要一些提示迁移。GPT-4.1 经过训练，比其前身更严格、更字面地遵循指令，而前身倾向于更自由地从用户和系统提示中推断意图。这也意味着，GPT-4.1 具有高度的可引导性，对明确指定的提示反应灵敏——如果模型行为与您期望的不同，一个坚定且明确澄清您期望行为的单句几乎总是足以引导模型回到正轨。</p>
<p>请继续阅读可用作参考的提示示例，并记住虽然这些指导广泛适用，但没有建议是万能的。AI 工程本质上是一门经验性学科，大型语言模型本质上是非确定性的；除了遵循本指南外，我们建议构建信息丰富的评估并经常迭代，以确保您的提示工程变更为您的用例带来好处。</p>
<h2 id="1-代理工作流"><a href="#1-代理工作流" class="headerlink" title="1. 代理工作流"></a>1. 代理工作流</h2><p>GPT-4.1 是构建代理工作流的绝佳选择。在模型训练中，我们强调提供多样化的代理问题解决轨迹，我们的模型代理框架在 SWE-bench Verified 上实现了非推理模型的最先进性能，解决了 55% 的问题。</p>
<h3 id="系统提示提醒"><a href="#系统提示提醒" class="headerlink" title="系统提示提醒"></a>系统提示提醒</h3><p>为了充分利用 GPT-4.1 的代理能力，我们建议在所有代理提示中包含三种关键类型的提醒。以下提示专门针对代理编码工作流进行了优化，但可以轻松修改用于一般代理用例。</p>
<ol>
<li><strong>持久性</strong>：这确保模型理解它正在进入多消息轮次，并防止它过早地将控制权交还给用户。我们的示例如下：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">你是一个代理 - 请继续直到用户的查询完全解决，然后结束你的轮次并交还给用户。只有在确定问题已解决时才终止你的轮次。</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>工具调用</strong>：这鼓励模型充分利用其工具，并减少其产生幻觉或猜测答案的可能性。我们的示例如下：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">如果你不确定与用户请求相关的文件内容或代码库结构，请使用你的工具读取文件并收集相关信息：不要猜测或编造答案。</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>规划</strong>（可选）：如果需要，这确保模型在文本中明确规划和反思每个工具调用，而不是仅通过链接一系列工具调用来完成任务。我们的示例如下：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">你必须在每个函数调用之前广泛规划，并广泛反思之前函数调用的结果。不要仅通过函数调用来完成整个过程，因为这可能会损害你解决问题和深入思考的能力。</span><br></pre></td></tr></table></figure>

<p>GPT-4.1 经过训练，在代理环境中对用户指令和系统提示都非常严格地响应。模型严格遵循这三个简单指令，我们的内部 SWE-bench Verified 分数提高了近 20%——因此我们强烈建议从涵盖上述三个类别的明确提醒开始任何代理提示。总的来说，我们发现这三个指令将模型从类似聊天机器人的状态转变为更加”渴望”的代理，自主且独立地推动交互向前发展。</p>
<h3 id="工具调用"><a href="#工具调用" class="headerlink" title="工具调用"></a>工具调用</h3><p>与之前的模型相比，GPT-4.1 在有效利用作为 OpenAI API 请求参数传递的工具方面接受了更多训练。我们鼓励开发者专门使用 tools 字段来传递工具，而不是手动将工具描述注入到提示中并为工具调用编写单独的解析器，正如一些人过去报告的那样。这是最小化错误并确保模型在工具调用轨迹期间保持分布的最佳方式——在我们自己的实验中，我们观察到使用 API 解析的工具描述与手动将模式注入系统提示相比，SWE-bench Verified 通过率提高了 2%。</p>
<p>开发者应该清楚地命名工具以表明其目的，并在工具的”description”字段中添加清晰、详细的描述。同样，对于每个工具参数，依靠良好的命名和描述来确保适当的使用。如果你的工具特别复杂，你想提供工具使用示例，我们建议你在系统提示中创建一个 <code># Examples</code> 部分并将示例放在那里，而不是将它们添加到”description”字段中，该字段应该保持全面但相对简洁。提供示例有助于指示何时使用工具、是否在工具调用中包含用户文本，以及哪些参数适合不同的输入。记住，你可以在 <a target="_blank" rel="noopener" href="https://platform.openai.com/playground">Prompt Playground</a> 中使用”Generate Anything”来为新工具定义获得良好的起点。</p>
<h3 id="提示诱导规划和思维链"><a href="#提示诱导规划和思维链" class="headerlink" title="提示诱导规划和思维链"></a>提示诱导规划和思维链</h3><p>如前所述，开发者可以选择性地提示使用 GPT-4.1 构建的代理在工具调用之间进行规划和反思，而不是在无间断序列中静默调用工具。GPT-4.1 不是一个推理模型——意味着它在回答之前不会产生内部思维链——但在提示中，开发者可以通过使用上面显示的规划提示组件的任何变体来诱导模型产生明确的、逐步的计划。这可以被认为是模型”大声思考”。在我们对 SWE-bench Verified 代理任务的实验中，诱导明确规划使通过率提高了 4%。</p>
<h3 id="示例提示：SWE-bench-Verified"><a href="#示例提示：SWE-bench-Verified" class="headerlink" title="示例提示：SWE-bench Verified"></a>示例提示：SWE-bench Verified</h3><p>下面，我们分享用于在 SWE-bench Verified 上获得最高分数的代理提示，该提示包含关于工作流和问题解决策略的详细指令。这种通用模式可用于任何代理任务。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> openai <span class="keyword">import</span> OpenAI</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">client = OpenAI(</span><br><span class="line">    api_key=os.environ.get(</span><br><span class="line">        <span class="string">&quot;OPENAI_API_KEY&quot;</span>, <span class="string">&quot;&lt;your OpenAI API key if not set as env var&gt;&quot;</span></span><br><span class="line">    )</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">SYS_PROMPT_SWEBENCH = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">你将被要求修复开源仓库中的问题。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">你的思考应该彻底，所以如果很长也没关系。你可以在决定采取每个行动之前和之后逐步思考。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">你必须迭代并继续直到问题解决。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">你已经在 /testbed 文件夹中拥有解决这个问题所需的一切，即使没有互联网连接。我希望你在回到我之前完全自主地解决这个问题。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">只有在确定问题已解决时才终止你的轮次。逐步解决问题，并确保验证你的更改是正确的。永远不要在没有解决问题的情况下结束你的轮次，当你说你要进行工具调用时，确保你实际上进行了工具调用，而不是结束你的轮次。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">问题绝对可以在没有互联网的情况下解决。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">花时间思考每一步 - 记住严格检查你的解决方案并注意边界情况，特别是你做的更改。你的解决方案必须是完美的。如果不是，继续努力。最后，你必须使用提供的工具严格测试你的代码，并多次测试，以捕获所有边界情况。如果它不够健壮，继续迭代并使其完美。未能充分严格地测试代码是这类任务的头号失败模式；确保你处理所有边界情况，如果提供了现有测试则运行它们。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">你必须在每个函数调用之前广泛规划，并广泛反思之前函数调用的结果。不要仅通过函数调用来完成整个过程，因为这可能会损害你解决问题和深入思考的能力。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 工作流</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 高级问题解决策略</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">1. 深入理解问题。仔细阅读问题并批判性地思考需要什么。</span></span><br><span class="line"><span class="string">2. 调查代码库。探索相关文件，搜索关键函数，并收集上下文。</span></span><br><span class="line"><span class="string">3. 制定清晰、逐步的计划。将修复分解为可管理的、增量步骤。</span></span><br><span class="line"><span class="string">4. 增量实施修复。进行小的、可测试的代码更改。</span></span><br><span class="line"><span class="string">5. 根据需要调试。使用调试技术隔离和解决问题。</span></span><br><span class="line"><span class="string">6. 频繁测试。每次更改后运行测试以验证正确性。</span></span><br><span class="line"><span class="string">7. 迭代直到根本原因修复且所有测试通过。</span></span><br><span class="line"><span class="string">8. 全面反思和验证。测试通过后，思考原始意图，编写额外测试以确保正确性，并记住还有隐藏测试也必须通过，解决方案才真正完成。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">请参考下面的详细部分以获取每个步骤的更多信息。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 1. 深入理解问题</span></span><br><span class="line"><span class="string">仔细阅读问题并在编码前认真思考解决计划。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 2. 代码库调查</span></span><br><span class="line"><span class="string">- 探索相关文件和目录。</span></span><br><span class="line"><span class="string">- 搜索与问题相关的关键函数、类或变量。</span></span><br><span class="line"><span class="string">- 阅读和理解相关代码片段。</span></span><br><span class="line"><span class="string">- 识别问题的根本原因。</span></span><br><span class="line"><span class="string">- 在收集更多上下文时持续验证和更新你的理解。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 3. 制定详细计划</span></span><br><span class="line"><span class="string">- 概述修复问题的具体、简单和可验证的步骤序列。</span></span><br><span class="line"><span class="string">- 将修复分解为小的、增量更改。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 4. 进行代码更改</span></span><br><span class="line"><span class="string">- 在编辑之前，始终读取相关文件内容或部分以确保完整上下文。</span></span><br><span class="line"><span class="string">- 如果补丁未正确应用，尝试重新应用。</span></span><br><span class="line"><span class="string">- 进行小的、可测试的、增量更改，这些更改逻辑上来自你的调查和计划。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 5. 调试</span></span><br><span class="line"><span class="string">- 仅在你高度确信它们可以解决问题时进行代码更改</span></span><br><span class="line"><span class="string">- 调试时，尝试确定根本原因而不是解决症状</span></span><br><span class="line"><span class="string">- 调试所需时间以识别根本原因并确定修复</span></span><br><span class="line"><span class="string">- 使用打印语句、日志或临时代码检查程序状态，包括描述性语句或错误消息以了解发生了什么</span></span><br><span class="line"><span class="string">- 为了测试假设，你还可以添加测试语句或函数</span></span><br><span class="line"><span class="string">- 如果发生意外行为，重新审视你的假设。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 6. 测试</span></span><br><span class="line"><span class="string">- 使用 `!python3 run_tests.py`（或等效）频繁运行测试。</span></span><br><span class="line"><span class="string">- 每次更改后，通过运行相关测试验证正确性。</span></span><br><span class="line"><span class="string">- 如果测试失败，分析失败并修改你的补丁。</span></span><br><span class="line"><span class="string">- 如果需要，编写额外测试以捕获重要行为或边界情况。</span></span><br><span class="line"><span class="string">- 在最终确定之前确保所有测试通过。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 7. 最终验证</span></span><br><span class="line"><span class="string">- 确认根本原因已修复。</span></span><br><span class="line"><span class="string">- 审查你的解决方案的逻辑正确性和健壮性。</span></span><br><span class="line"><span class="string">- 迭代直到你极其确信修复完成且所有测试通过。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 8. 最终反思和额外测试</span></span><br><span class="line"><span class="string">- 仔细反思用户的原始意图和问题陈述。</span></span><br><span class="line"><span class="string">- 考虑可能未被现有测试覆盖的潜在边界情况或场景。</span></span><br><span class="line"><span class="string">- 编写需要通过的额外测试以完全验证你的解决方案的正确性。</span></span><br><span class="line"><span class="string">- 运行这些新测试并确保它们都通过。</span></span><br><span class="line"><span class="string">- 注意还有额外的隐藏测试也必须通过，解决方案才能成功。</span></span><br><span class="line"><span class="string">- 不要仅仅因为可见测试通过就假设任务完成；继续完善直到你确信修复是健壮和全面的。</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">PYTHON_TOOL_DESCRIPTION = <span class="string">&quot;&quot;&quot;此函数用于在有状态的 Jupyter notebook 环境中执行 Python 代码或终端命令。python 将响应执行输出或在 60.0 秒后超时。此会话的互联网访问已禁用。不要进行外部网络请求或 API 调用，因为它们会失败。就像在 Jupyter notebook 中一样，你也可以通过调用此函数并带有以感叹号开头的终端命令来执行终端命令。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">此外，出于此任务的目的，你可以使用 `apply_patch` 命令作为输入调用此函数。`apply_patch` 有效地允许你对文件执行 diff/patch，但 diff 规范的格式对此任务是唯一的，所以请仔细注意这些指令。要使用 `apply_patch` 命令，你应该将以下结构的消息作为&quot;input&quot;传递：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">%%bash</span></span><br><span class="line"><span class="string">apply_patch &lt;&lt;&quot;EOF&quot;</span></span><br><span class="line"><span class="string">*** Begin Patch</span></span><br><span class="line"><span class="string">[YOUR_PATCH]</span></span><br><span class="line"><span class="string">*** End Patch</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">其中 [YOUR_PATCH] 是你的补丁的实际内容，以以下 V4A diff 格式指定。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">*** [ACTION] File: [path/to/file] -&gt; ACTION 可以是 Add、Update 或 Delete 之一。</span></span><br><span class="line"><span class="string">对于需要更改的每个代码片段，重复以下内容：</span></span><br><span class="line"><span class="string">[context_before] -&gt; 参见下面关于上下文的进一步说明。</span></span><br><span class="line"><span class="string">- [old_code] -&gt; 在旧代码前加减号。</span></span><br><span class="line"><span class="string">+ [new_code] -&gt; 在新替换代码前加加号。</span></span><br><span class="line"><span class="string">[context_after] -&gt; 参见下面关于上下文的进一步说明。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">关于 [context_before] 和 [context_after] 的说明：</span></span><br><span class="line"><span class="string">- 默认情况下，显示每个更改上方和下方的 3 行代码。如果一个更改在另一个更改的 3 行内，不要在第二个更改的 [context_before] 行中重复第一个更改的 [context_after] 行。</span></span><br><span class="line"><span class="string">- 如果 3 行上下文不足以唯一标识文件中的代码片段，使用 @@ 操作符指示代码片段所属的类或函数。例如，我们可能有：</span></span><br><span class="line"><span class="string">@@ class BaseClass</span></span><br><span class="line"><span class="string">[3 行预上下文]</span></span><br><span class="line"><span class="string">- [old_code]</span></span><br><span class="line"><span class="string">+ [new_code]</span></span><br><span class="line"><span class="string">[3 行后上下文]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- 如果一个代码块在类或函数中重复如此多次，以至于即使单个 @@ 语句和 3 行上下文也无法唯一标识代码片段，你可以使用多个 `@@` 语句跳转到正确的上下文。例如：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@@ class BaseClass</span></span><br><span class="line"><span class="string">@@ 	def method():</span></span><br><span class="line"><span class="string">[3 行预上下文]</span></span><br><span class="line"><span class="string">- [old_code]</span></span><br><span class="line"><span class="string">+ [new_code]</span></span><br><span class="line"><span class="string">[3 行后上下文]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">注意，我们不在此 diff 格式中使用行号，因为上下文足以唯一标识代码。你可能作为&quot;input&quot;传递给此函数以应用补丁的消息示例如下所示。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">%%bash</span></span><br><span class="line"><span class="string">apply_patch &lt;&lt;&quot;EOF&quot;</span></span><br><span class="line"><span class="string">*** Begin Patch</span></span><br><span class="line"><span class="string">*** Update File: pygorithm/searching/binary_search.py</span></span><br><span class="line"><span class="string">@@ class BaseClass</span></span><br><span class="line"><span class="string">@@     def search():</span></span><br><span class="line"><span class="string">-        pass</span></span><br><span class="line"><span class="string">+        raise NotImplementedError()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@@ class Subclass</span></span><br><span class="line"><span class="string">@@     def search():</span></span><br><span class="line"><span class="string">-        pass</span></span><br><span class="line"><span class="string">+        raise NotImplementedError()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">*** End Patch</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">文件引用只能是相对的，永远不要是绝对的。运行 apply_patch 命令后，python 总是会说&quot;Done!&quot;，无论补丁是否成功应用。但是，你可以通过查看在&quot;Done!&quot;输出之前打印的任何警告或日志行来确定是否有问题和错误。</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">python_bash_patch_tool = &#123;</span><br><span class="line">  <span class="string">&quot;type&quot;</span>: <span class="string">&quot;function&quot;</span>,</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;python&quot;</span>,</span><br><span class="line">  <span class="string">&quot;description&quot;</span>: PYTHON_TOOL_DESCRIPTION,</span><br><span class="line">  <span class="string">&quot;parameters&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;strict&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="string">&quot;object&quot;</span>,</span><br><span class="line">      <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;input&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">              <span class="string">&quot;description&quot;</span>: <span class="string">&quot; 你希望执行的 Python 代码、终端命令（以感叹号开头）或 apply_patch 命令。&quot;</span>,</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;required&quot;</span>: [<span class="string">&quot;input&quot;</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 额外的框架设置：</span></span><br><span class="line"><span class="comment"># - 将你的仓库添加到 /testbed</span></span><br><span class="line"><span class="comment"># - 将你的问题添加到第一个用户消息</span></span><br><span class="line"><span class="comment"># - 注意：尽管我们为 python、bash 和 apply_patch 使用了单个工具，但我们通常建议定义更细粒度的工具，专注于单个功能</span></span><br><span class="line"></span><br><span class="line">response = client.responses.create(</span><br><span class="line">    instructions=SYS_PROMPT_SWEBENCH,</span><br><span class="line">    model=<span class="string">&quot;gpt-4.1-2025-04-14&quot;</span>,</span><br><span class="line">    tools=[python_bash_patch_tool],</span><br><span class="line">    <span class="built_in">input</span>=<span class="string">f&quot;请回答以下问题：\nBug: Typerror...&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">response.to_dict()[<span class="string">&quot;output&quot;</span>]</span><br></pre></td></tr></table></figure>

<h2 id="2-长上下文"><a href="#2-长上下文" class="headerlink" title="2. 长上下文"></a>2. 长上下文</h2><p>GPT-4.1 具有高性能的 100 万 token 输入上下文窗口，适用于各种长上下文任务，包括结构化文档解析、重新排序、在忽略无关上下文的同时选择相关信息，以及使用上下文执行多跳推理。</p>
<h3 id="最佳上下文大小"><a href="#最佳上下文大小" class="headerlink" title="最佳上下文大小"></a>最佳上下文大小</h3><p>我们观察到在针在干草堆评估中，直到我们完整的 100 万 token 上下文都有很好的性能，我们观察到在具有相关和无关代码以及其他文档混合的复杂任务中有很强的性能。然而，长上下文性能可能会随着需要检索更多项目或执行需要了解整个上下文状态的复杂推理（例如执行图搜索）而降低。</p>
<h3 id="调整上下文依赖"><a href="#调整上下文依赖" class="headerlink" title="调整上下文依赖"></a>调整上下文依赖</h3><p>考虑回答你的问题可能需要的内部与外部世界知识的混合。有时模型使用一些自己的知识来连接概念或进行逻辑跳跃很重要，而在其他情况下，只使用提供的上下文是可取的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 指令</span><br><span class="line">// 用于内部知识</span><br><span class="line">- 仅使用提供的外部上下文中的文档来回答用户查询。如果你基于此上下文不知道答案，你必须回应&quot;我没有回答该问题所需的信息&quot;，即使用户坚持要你回答问题。</span><br><span class="line">// 用于内部和外部知识</span><br><span class="line">- 默认情况下，使用提供的外部上下文来回答用户查询，但如果需要其他基本知识来回答，并且你对答案有信心，你可以使用一些自己的知识来帮助回答问题。</span><br></pre></td></tr></table></figure>

<h3 id="提示组织"><a href="#提示组织" class="headerlink" title="提示组织"></a>提示组织</h3><p>特别是在长上下文使用中，指令和上下文的放置会影响性能。如果你的提示中有长上下文，理想情况下将你的指令放在提供上下文的开始和结束，因为我们发现这比仅在上下或下方表现更好。如果你希望只将指令放在一次，那么在提供的上下文上方比下方效果更好。</p>
<h2 id="3-思维链"><a href="#3-思维链" class="headerlink" title="3. 思维链"></a>3. 思维链</h2><p>如上所述，GPT-4.1 不是一个推理模型，但提示模型逐步思考（称为”思维链”）可以是模型将问题分解为更易管理的部分、解决它们并提高整体输出质量的有效方式，但代价是使用更多输出 token 的更高成本和延迟。该模型经过训练，在代理推理和现实世界问题解决方面表现良好，因此它不应该需要太多提示就能表现良好。</p>
<p>我们建议从提示末尾的这个基本思维链指令开始：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">首先，仔细逐步思考回答查询需要哪些文档。然后，打印出每个文档的标题和 ID。然后，将 ID 格式化为列表。</span><br></pre></td></tr></table></figure>

<p>从那里，你应该通过审计你特定示例和评估中的失败，并用更明确的指令解决系统性规划和推理错误来改进你的思维链（CoT）提示。在无约束的 CoT 提示中，它尝试的策略可能有差异，如果你观察到一种效果很好的方法，你可以在提示中编码该策略。一般来说，错误往往来自误解用户意图、上下文收集或分析不足，或逐步思考不足或不正确，所以注意这些并尝试用更有主见的指令解决它们。</p>
<p>这是一个示例提示，指示模型更系统地专注于分析用户意图并在继续回答之前考虑相关上下文。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 推理策略</span><br><span class="line">1. 查询分析：分解和分析查询，直到你对其可能询问的内容有信心。考虑提供的上下文以帮助澄清任何模糊或令人困惑的信息。</span><br><span class="line">2. 上下文分析：仔细选择和分析大量潜在相关文档。优化召回 - 如果有些无关紧要也没关系，但正确的文档必须在此列表中，否则你的最终答案将是错误的。每个的分析步骤：</span><br><span class="line">	a. 分析：分析它可能与回答查询相关或不相关的分析。</span><br><span class="line">	b. 相关性评级：[高、中、低、无]</span><br><span class="line">3. 综合：总结哪些文档最相关以及原因，包括相关性评级为中等或更高的所有文档。</span><br><span class="line"></span><br><span class="line"># 用户问题</span><br><span class="line">&#123;user_question&#125;</span><br><span class="line"></span><br><span class="line"># 外部上下文</span><br><span class="line">&#123;external_context&#125;</span><br><span class="line"></span><br><span class="line">首先，仔细逐步思考回答查询需要哪些文档，严格遵循提供的推理策略。然后，打印出每个文档的标题和 ID。然后，将 ID 格式化为列表。</span><br></pre></td></tr></table></figure>

<h2 id="4-指令遵循"><a href="#4-指令遵循" class="headerlink" title="4. 指令遵循"></a>4. 指令遵循</h2><p>GPT-4.1 表现出出色的指令遵循性能，开发者可以利用这一点来精确塑造和控制其特定用例的输出。开发者经常广泛提示代理推理步骤、响应语气和声音、工具调用信息、输出格式、要避免的主题等。然而，由于模型更字面地遵循指令，开发者可能需要包含关于做什么或不做什么的明确规范。此外，为其他模型优化的现有提示可能不会立即与此模型一起工作，因为现有指令被更严格地遵循。</p>
<p>这演示了虚构客户服务代理的最佳实践。观察规则的多样性、具体性、使用额外部分获得更多细节，以及一个示例来演示整合所有先前规则的精确行为。</p>
<p>尝试运行以下 notebook 单元格 - 你应该看到用户消息和工具调用，用户消息应该以问候开始，然后回显他们的答案，然后提到他们即将调用工具。尝试更改指令来塑造模型行为，或尝试其他用户消息，以测试指令遵循性能。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">SYS_PROMPT_CUSTOMER_SERVICE = <span class="string">&quot;&quot;&quot;你是 NewTelco 的有用客户服务代理，帮助用户高效地满足他们的请求，同时严格遵守提供的指导方针。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 指令</span></span><br><span class="line"><span class="string">- 始终用&quot;你好，你已联系到 NewTelco，我能帮你什么？&quot;问候用户</span></span><br><span class="line"><span class="string">- 在回答关于公司、其产品或服务或用户账户的事实性问题之前，始终调用工具。仅使用检索的上下文，永远不要依赖你自己的知识来回答这些问题。</span></span><br><span class="line"><span class="string">    - 但是，如果你没有足够的信息来正确调用工具，请向用户询问你需要的信息。</span></span><br><span class="line"><span class="string">- 如果用户请求，升级到人工。</span></span><br><span class="line"><span class="string">- 不要讨论禁止的主题（政治、宗教、有争议的时事、医疗、法律或财务建议、个人对话、内部公司运营，或对任何人员或公司的批评）。</span></span><br><span class="line"><span class="string">- 在适当时依赖示例短语，但永远不要在同一对话中重复示例短语。随意变化示例短语以避免听起来重复，并使其更适合用户。</span></span><br><span class="line"><span class="string">- 始终遵循新消息的提供输出格式，包括对检索的政策文档中任何事实陈述的引用。</span></span><br><span class="line"><span class="string">- 如果你要调用工具，始终在调用工具之前和之后向用户发送适当的消息。</span></span><br><span class="line"><span class="string">- 在所有回复中保持专业和简洁的语气，并在句子之间使用表情符号。</span></span><br><span class="line"><span class="string">- 如果你已解决用户的请求，询问是否还有其他可以帮忙的</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 精确响应步骤（每次响应）</span></span><br><span class="line"><span class="string">1. 如有必要，调用工具来满足用户期望的行动。始终在调用工具之前和之后向用户发送消息，让他们了解情况。</span></span><br><span class="line"><span class="string">2. 在你的用户回复中</span></span><br><span class="line"><span class="string">    a. 使用积极倾听并回显你听到用户要求的内容。</span></span><br><span class="line"><span class="string">    b. 根据上述指导方针适当回应。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 示例短语</span></span><br><span class="line"><span class="string">## 转移禁止主题</span></span><br><span class="line"><span class="string">- &quot;对不起，但我无法讨论该主题。还有其他我可以帮助你的吗？&quot;</span></span><br><span class="line"><span class="string">- &quot;这不是我能够提供信息的内容，但我很乐意帮助你解决其他问题。&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 调用工具前</span></span><br><span class="line"><span class="string">- &quot;为了帮助你，我只需要验证你的信息。&quot;</span></span><br><span class="line"><span class="string">- &quot;让我为你检查一下——请稍等。&quot;</span></span><br><span class="line"><span class="string">- &quot;我现在为你检索最新详情。&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 调用工具后</span></span><br><span class="line"><span class="string">- &quot;好的，这是我找到的：[回复]&quot;</span></span><br><span class="line"><span class="string">- &quot;所以我找到的是：[回复]&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 输出格式</span></span><br><span class="line"><span class="string">- 始终包含你对用户的最终回复。</span></span><br><span class="line"><span class="string">- 在提供来自检索上下文的事实信息时，始终在相关陈述后立即包含引用。使用以下引用格式：</span></span><br><span class="line"><span class="string">    - 对于单个来源：[NAME](ID)</span></span><br><span class="line"><span class="string">    - 对于多个来源：[NAME](ID), [NAME](ID)</span></span><br><span class="line"><span class="string">- 仅提供关于此公司、其政策、其产品或客户账户的信息，并且仅基于上下文中提供的信息。不要回答此范围之外的问题。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 示例</span></span><br><span class="line"><span class="string">## 用户</span></span><br><span class="line"><span class="string">你能告诉我你们的家庭计划选项吗？</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 助手回复 1</span></span><br><span class="line"><span class="string">### 消息</span></span><br><span class="line"><span class="string">&quot;你好，你已联系到 NewTelco，我能帮你什么？ 😊🎉</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">你想了解我们的家庭计划选项。 🤝 让我为你检查一下——请稍等。 🚀&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### 工具调用</span></span><br><span class="line"><span class="string">lookup_policy_document(topic=&quot;family plan options&quot;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// 工具调用后，助手会跟进：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 助手回复 2（工具调用后）</span></span><br><span class="line"><span class="string">### 消息</span></span><br><span class="line"><span class="string">&quot;好的，这是我找到的： 🎉 我们的家庭计划允许最多 5 条线路共享数据，每条额外线路享受 10% 折扣 [家庭计划政策](ID-010)。 📱 今天还有其他我可以帮助你的吗？ 😊&quot;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">get_policy_doc = &#123;</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;function&quot;</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;lookup_policy_document&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;按主题或关键词查找内部文档和政策的工具。&quot;</span>,</span><br><span class="line">    <span class="string">&quot;parameters&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;strict&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;object&quot;</span>,</span><br><span class="line">        <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;topic&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">                <span class="string">&quot;description&quot;</span>: <span class="string">&quot;在公司政策或文档中搜索的主题或关键词。&quot;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;required&quot;</span>: [<span class="string">&quot;topic&quot;</span>],</span><br><span class="line">        <span class="string">&quot;additionalProperties&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">get_user_acct = &#123;</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;function&quot;</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;get_user_account_info&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;获取用户账户信息的工具&quot;</span>,</span><br><span class="line">    <span class="string">&quot;parameters&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;strict&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;object&quot;</span>,</span><br><span class="line">        <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;phone_number&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">                <span class="string">&quot;description&quot;</span>: <span class="string">&quot;格式为 &#x27;(xxx) xxx-xxxx&#x27;&quot;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;required&quot;</span>: [<span class="string">&quot;phone_number&quot;</span>],</span><br><span class="line">        <span class="string">&quot;additionalProperties&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">response = client.responses.create(</span><br><span class="line">    instructions=SYS_PROMPT_CUSTOMER_SERVICE,</span><br><span class="line">    model=<span class="string">&quot;gpt-4.1-2025-04-14&quot;</span>,</span><br><span class="line">    tools=[get_policy_doc, get_user_acct],</span><br><span class="line">    <span class="built_in">input</span>=<span class="string">&quot;国际服务要多少钱？我要去法国。&quot;</span>,</span><br><span class="line">    <span class="comment"># input=&quot;为什么我上个月的账单这么高？&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">response.to_dict()[<span class="string">&quot;output&quot;</span>]</span><br></pre></td></tr></table></figure>

<h2 id="5-一般建议"><a href="#5-一般建议" class="headerlink" title="5. 一般建议"></a>5. 一般建议</h2><h3 id="提示结构"><a href="#提示结构" class="headerlink" title="提示结构"></a>提示结构</h3><p>作为参考，这是构建提示的良好起点。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 角色和目标</span><br><span class="line"></span><br><span class="line"># 指令</span><br><span class="line"></span><br><span class="line">## 更详细指令的子类别</span><br><span class="line"></span><br><span class="line"># 推理步骤</span><br><span class="line"></span><br><span class="line"># 输出格式</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">## 示例 1</span><br><span class="line"></span><br><span class="line"># 上下文</span><br><span class="line"></span><br><span class="line"># 最终指令和逐步思考的提示</span><br></pre></td></tr></table></figure>

<p>添加或删除部分以满足你的需求，并进行实验以确定对你的使用最优的内容。</p>
<h3 id="分隔符"><a href="#分隔符" class="headerlink" title="分隔符"></a>分隔符</h3><p>以下是为提示选择最佳分隔符的一些一般指导原则。请参考长上下文部分以获取该上下文类型的特殊考虑。</p>
<ol>
<li><p><strong>Markdown</strong>：我们建议从这里开始，使用 markdown 标题作为主要部分和子部分（包括更深的层次结构，到 H4+）。使用内联反引号或反引号块来精确包装代码，并根据需要使用标准编号或项目符号列表。</p>
</li>
<li><p><strong>XML</strong>：这些也表现良好，我们改进了此模型对 XML 中信息的遵循。XML 便于精确包装包括开始和结束的部分，为标签添加元数据以获得额外上下文，并启用嵌套。以下是使用 XML 标签在示例部分中嵌套示例的示例，每个都有输入和输出：</p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;examples&gt;</span><br><span class="line">&lt;example1 type=&quot;Abbreviate&quot;&gt;</span><br><span class="line">&lt;input&gt;San Francisco&lt;/input&gt;</span><br><span class="line">&lt;output&gt;- SF&lt;/output&gt;</span><br><span class="line">&lt;/example1&gt;</span><br><span class="line">&lt;/examples&gt;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>JSON</strong> 高度结构化，模型在编码上下文中特别理解良好。但它可能更冗长，并且需要字符转义，这会增加开销。</li>
</ol>
<p>专门用于向输入上下文添加大量文档或文件的指导：</p>
<ul>
<li>XML 在我们的长上下文测试中表现良好。<ul>
<li>示例：<code>&lt;doc id=&#39;1&#39; title=&#39;The Fox&#39;&gt;The quick brown fox jumps over the lazy dog&lt;/doc&gt;</code></li>
</ul>
</li>
<li>这种格式由 Lee 等人提出（<a target="_blank" rel="noopener" href="https://arxiv.org/pdf/2406.13121">ref</a>），在我们的长上下文测试中也表现良好。<ul>
<li>示例：<code>ID: 1 | TITLE: The Fox | CONTENT: The quick brown fox jumps over the lazy dog</code></li>
</ul>
</li>
<li>JSON 表现特别差。<ul>
<li>示例：<code>[&#123;&#39;id&#39;: 1, &#39;title&#39;: &#39;The Fox&#39;, &#39;content&#39;: &#39;The quick brown fox jumped over the lazy dog&#39;&#125;]</code></li>
</ul>
</li>
</ul>
<p>模型经过训练，能够稳健地理解各种格式的结构。一般来说，使用你的判断并思考什么将提供清晰的信息并”突出”给模型。例如，如果你检索的文档包含大量 XML，基于 XML 的分隔符可能效果较差。</p>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ul>
<li>在一些孤立的情况下，我们观察到模型抵制产生很长、重复的输出，例如，逐个分析数百个项目。如果这对你的用例是必要的，强烈指示模型完整输出此信息，并考虑分解问题或使用更简洁的方法。</li>
<li>我们看到一些罕见的并行工具调用不正确的情况。我们建议测试这个，并考虑将 <a target="_blank" rel="noopener" href="https://platform.openai.com/docs/api-reference/responses/create#responses-create-parallel_tool_calls">parallel_tool_calls</a> 参数设置为 false，如果你看到问题。</li>
</ul>
<h2 id="附录：生成和应用文件差异"><a href="#附录：生成和应用文件差异" class="headerlink" title="附录：生成和应用文件差异"></a>附录：生成和应用文件差异</h2><p>开发者向我们提供反馈，准确和格式良好的差异生成是为编码相关任务提供动力的关键能力。为此，GPT-4.1 系列相对于之前的 GPT 模型具有显著改进的差异功能。此外，虽然 GPT-4.1 在给定清晰指令和示例的情况下在生成任何格式的差异方面都有很强的性能，但我们在这里开源一个推荐的差异格式，模型在这方面接受了大量训练。我们特别希望对于刚开始的开发者，这将消除你自己创建差异的大部分猜测工作。</p>
<h3 id="应用补丁"><a href="#应用补丁" class="headerlink" title="应用补丁"></a>应用补丁</h3><p>请参阅下面的示例，了解正确应用我们推荐的工具调用的提示。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">APPLY_PATCH_TOOL_DESC = <span class="string">&quot;&quot;&quot;这是一个自定义实用程序，使添加、删除、移动或编辑代码文件更加方便。`apply_patch` 有效地允许你对文件执行 diff/patch，但 diff 规范的格式对此任务是唯一的，所以请仔细注意这些指令。要使用 `apply_patch` 命令，你应该将以下结构的消息作为&quot;input&quot;传递：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">%%bash</span></span><br><span class="line"><span class="string">apply_patch &lt;&lt;&quot;EOF&quot;</span></span><br><span class="line"><span class="string">*** Begin Patch</span></span><br><span class="line"><span class="string">[YOUR_PATCH]</span></span><br><span class="line"><span class="string">*** End Patch</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">其中 [YOUR_PATCH] 是你的补丁的实际内容，以以下 V4A diff 格式指定。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">*** [ACTION] File: [path/to/file] -&gt; ACTION 可以是 Add、Update 或 Delete 之一。</span></span><br><span class="line"><span class="string">对于需要更改的每个代码片段，重复以下内容：</span></span><br><span class="line"><span class="string">[context_before] -&gt; 参见下面关于上下文的进一步说明。</span></span><br><span class="line"><span class="string">- [old_code] -&gt; 在旧代码前加减号。</span></span><br><span class="line"><span class="string">+ [new_code] -&gt; 在新替换代码前加加号。</span></span><br><span class="line"><span class="string">[context_after] -&gt; 参见下面关于上下文的进一步说明。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">关于 [context_before] 和 [context_after] 的说明：</span></span><br><span class="line"><span class="string">- 默认情况下，显示每个更改上方和下方的 3 行代码。如果一个更改在另一个更改的 3 行内，不要在第二个更改的 [context_before] 行中重复第一个更改的 [context_after] 行。</span></span><br><span class="line"><span class="string">- 如果 3 行上下文不足以唯一标识文件中的代码片段，使用 @@ 操作符指示代码片段所属的类或函数。例如，我们可能有：</span></span><br><span class="line"><span class="string">@@ class BaseClass</span></span><br><span class="line"><span class="string">[3 行预上下文]</span></span><br><span class="line"><span class="string">- [old_code]</span></span><br><span class="line"><span class="string">+ [new_code]</span></span><br><span class="line"><span class="string">[3 行后上下文]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- 如果一个代码块在类或函数中重复如此多次，以至于即使单个 @@ 语句和 3 行上下文也无法唯一标识代码片段，你可以使用多个 `@@` 语句跳转到正确的上下文。例如：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@@ class BaseClass</span></span><br><span class="line"><span class="string">@@ 	def method():</span></span><br><span class="line"><span class="string">[3 行预上下文]</span></span><br><span class="line"><span class="string">- [old_code]</span></span><br><span class="line"><span class="string">+ [new_code]</span></span><br><span class="line"><span class="string">[3 行后上下文]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">注意，我们不在此 diff 格式中使用行号，因为上下文足以唯一标识代码。你可能作为&quot;input&quot;传递给此函数以应用补丁的消息示例如下所示。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">%%bash</span></span><br><span class="line"><span class="string">apply_patch &lt;&lt;&quot;EOF&quot;</span></span><br><span class="line"><span class="string">*** Begin Patch</span></span><br><span class="line"><span class="string">*** Update File: pygorithm/searching/binary_search.py</span></span><br><span class="line"><span class="string">@@ class BaseClass</span></span><br><span class="line"><span class="string">@@     def search():</span></span><br><span class="line"><span class="string">-        pass</span></span><br><span class="line"><span class="string">+        raise NotImplementedError()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@@ class Subclass</span></span><br><span class="line"><span class="string">@@     def search():</span></span><br><span class="line"><span class="string">-        pass</span></span><br><span class="line"><span class="string">+        raise NotImplementedError()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">*** End Patch</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">文件引用只能是相对的，永远不要是绝对的。运行 apply_patch 命令后，python 总是会说&quot;Done!&quot;，无论补丁是否成功应用。但是，你可以通过查看在&quot;Done!&quot;输出之前打印的任何警告或日志行来确定是否有问题和错误。</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">APPLY_PATCH_TOOL = &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;apply_patch&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: APPLY_PATCH_TOOL_DESC,</span><br><span class="line">    <span class="string">&quot;parameters&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;object&quot;</span>,</span><br><span class="line">        <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;input&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">                <span class="string">&quot;description&quot;</span>: <span class="string">&quot; 你希望执行的 apply_patch 命令。&quot;</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;required&quot;</span>: [<span class="string">&quot;input&quot;</span>],</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="参考实现：apply-patch-py"><a href="#参考实现：apply-patch-py" class="headerlink" title="参考实现：apply_patch.py"></a>参考实现：apply_patch.py</h3><p>这是我们作为模型训练一部分使用的 apply_patch 工具的参考实现。你需要使其可执行并作为 <code>apply_patch</code> 从模型将执行命令的 shell 中可用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">A self-contained **pure-Python 3.9+** utility for applying human-readable</span></span><br><span class="line"><span class="string">“pseudo-diff” patch files to a collection of text files.</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pathlib</span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass, field</span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> (</span><br><span class="line">    <span class="type">Callable</span>,</span><br><span class="line">    <span class="type">Dict</span>,</span><br><span class="line">    <span class="type">List</span>,</span><br><span class="line">    <span class="type">Optional</span>,</span><br><span class="line">    <span class="type">Tuple</span>,</span><br><span class="line">    <span class="type">Union</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --------------------------------------------------------------------------- #</span></span><br><span class="line"><span class="comment">#  Domain objects</span></span><br><span class="line"><span class="comment"># --------------------------------------------------------------------------- #</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ActionType</span>(<span class="built_in">str</span>, Enum):</span><br><span class="line">    ADD = <span class="string">&quot;add&quot;</span></span><br><span class="line">    DELETE = <span class="string">&quot;delete&quot;</span></span><br><span class="line">    UPDATE = <span class="string">&quot;update&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileChange</span>:</span><br><span class="line">    <span class="built_in">type</span>: ActionType</span><br><span class="line">    old_content: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    new_content: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    move_path: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Commit</span>:</span><br><span class="line">    changes: <span class="type">Dict</span>[<span class="built_in">str</span>, FileChange] = field(default_factory=<span class="built_in">dict</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --------------------------------------------------------------------------- #</span></span><br><span class="line"><span class="comment">#  Exceptions</span></span><br><span class="line"><span class="comment"># --------------------------------------------------------------------------- #</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DiffError</span>(<span class="title class_ inherited__">ValueError</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Any problem detected while parsing or applying a patch.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --------------------------------------------------------------------------- #</span></span><br><span class="line"><span class="comment">#  Helper dataclasses used while parsing patches</span></span><br><span class="line"><span class="comment"># --------------------------------------------------------------------------- #</span></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Chunk</span>:</span><br><span class="line">    orig_index: <span class="built_in">int</span> = -<span class="number">1</span></span><br><span class="line">    del_lines: <span class="type">List</span>[<span class="built_in">str</span>] = field(default_factory=<span class="built_in">list</span>)</span><br><span class="line">    ins_lines: <span class="type">List</span>[<span class="built_in">str</span>] = field(default_factory=<span class="built_in">list</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PatchAction</span>:</span><br><span class="line">    <span class="built_in">type</span>: ActionType</span><br><span class="line">    new_file: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    chunks: <span class="type">List</span>[Chunk] = field(default_factory=<span class="built_in">list</span>)</span><br><span class="line">    move_path: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Patch</span>:</span><br><span class="line">    actions: <span class="type">Dict</span>[<span class="built_in">str</span>, PatchAction] = field(default_factory=<span class="built_in">dict</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --------------------------------------------------------------------------- #</span></span><br><span class="line"><span class="comment">#  Patch text parser</span></span><br><span class="line"><span class="comment"># --------------------------------------------------------------------------- #</span></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Parser</span>:</span><br><span class="line">    current_files: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>]</span><br><span class="line">    lines: <span class="type">List</span>[<span class="built_in">str</span>]</span><br><span class="line">    index: <span class="built_in">int</span> = <span class="number">0</span></span><br><span class="line">    patch: Patch = field(default_factory=Patch)</span><br><span class="line">    fuzz: <span class="built_in">int</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ------------- low-level helpers -------------------------------------- #</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_cur_line</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="keyword">if</span> self.index &gt;= <span class="built_in">len</span>(self.lines):</span><br><span class="line">            <span class="keyword">raise</span> DiffError(<span class="string">&quot;Unexpected end of input while parsing patch&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> self.lines[self.index]</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_norm</span>(<span class="params">line: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Strip CR so comparisons work for both LF and CRLF input.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> line.rstrip(<span class="string">&quot;\r&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ------------- scanning convenience ----------------------------------- #</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_done</span>(<span class="params">self, prefixes: <span class="type">Optional</span>[<span class="type">Tuple</span>[<span class="built_in">str</span>, ...]] = <span class="literal">None</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="keyword">if</span> self.index &gt;= <span class="built_in">len</span>(self.lines):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            prefixes</span><br><span class="line">            <span class="keyword">and</span> <span class="built_in">len</span>(prefixes) &gt; <span class="number">0</span></span><br><span class="line">            <span class="keyword">and</span> self._norm(self._cur_line()).startswith(prefixes)</span><br><span class="line">        ):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">startswith</span>(<span class="params">self, prefix: <span class="type">Union</span>[<span class="built_in">str</span>, <span class="type">Tuple</span>[<span class="built_in">str</span>, ...]]</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="keyword">return</span> self._norm(self._cur_line()).startswith(prefix)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read_str</span>(<span class="params">self, prefix: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Consume the current line if it starts with *prefix* and return the text</span></span><br><span class="line"><span class="string">        **after** the prefix.  Raises if prefix is empty.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> prefix == <span class="string">&quot;&quot;</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;read_str() requires a non-empty prefix&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> self._norm(self._cur_line()).startswith(prefix):</span><br><span class="line">            text = self._cur_line()[<span class="built_in">len</span>(prefix) :]</span><br><span class="line">            self.index += <span class="number">1</span></span><br><span class="line">            <span class="keyword">return</span> text</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read_line</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Return the current raw line and advance.&quot;&quot;&quot;</span></span><br><span class="line">        line = self._cur_line()</span><br><span class="line">        self.index += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> line</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ------------- public entry point -------------------------------------- #</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">parse</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> self.is_done((<span class="string">&quot;*** End Patch&quot;</span>,)):</span><br><span class="line">            <span class="comment"># ---------- UPDATE ---------- #</span></span><br><span class="line">            path = self.read_str(<span class="string">&quot;*** Update File: &quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> path:</span><br><span class="line">                <span class="keyword">if</span> path <span class="keyword">in</span> self.patch.actions:</span><br><span class="line">                    <span class="keyword">raise</span> DiffError(<span class="string">f&quot;Duplicate update for file: <span class="subst">&#123;path&#125;</span>&quot;</span>)</span><br><span class="line">                move_to = self.read_str(<span class="string">&quot;*** Move to: &quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> path <span class="keyword">not</span> <span class="keyword">in</span> self.current_files:</span><br><span class="line">                    <span class="keyword">raise</span> DiffError(<span class="string">f&quot;Update File Error - missing file: <span class="subst">&#123;path&#125;</span>&quot;</span>)</span><br><span class="line">                text = self.current_files[path]</span><br><span class="line">                action = self._parse_update_file(text)</span><br><span class="line">                action.move_path = move_to <span class="keyword">or</span> <span class="literal">None</span></span><br><span class="line">                self.patch.actions[path] = action</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># ---------- DELETE ---------- #</span></span><br><span class="line">            path = self.read_str(<span class="string">&quot;*** Delete File: &quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> path:</span><br><span class="line">                <span class="keyword">if</span> path <span class="keyword">in</span> self.patch.actions:</span><br><span class="line">                    <span class="keyword">raise</span> DiffError(<span class="string">f&quot;Duplicate delete for file: <span class="subst">&#123;path&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> path <span class="keyword">not</span> <span class="keyword">in</span> self.current_files:</span><br><span class="line">                    <span class="keyword">raise</span> DiffError(<span class="string">f&quot;Delete File Error - missing file: <span class="subst">&#123;path&#125;</span>&quot;</span>)</span><br><span class="line">                self.patch.actions[path] = PatchAction(<span class="built_in">type</span>=ActionType.DELETE)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># ---------- ADD ---------- #</span></span><br><span class="line">            path = self.read_str(<span class="string">&quot;*** Add File: &quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> path:</span><br><span class="line">                <span class="keyword">if</span> path <span class="keyword">in</span> self.patch.actions:</span><br><span class="line">                    <span class="keyword">raise</span> DiffError(<span class="string">f&quot;Duplicate add for file: <span class="subst">&#123;path&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> path <span class="keyword">in</span> self.current_files:</span><br><span class="line">                    <span class="keyword">raise</span> DiffError(<span class="string">f&quot;Add File Error - file already exists: <span class="subst">&#123;path&#125;</span>&quot;</span>)</span><br><span class="line">                self.patch.actions[path] = self._parse_add_file()</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">raise</span> DiffError(<span class="string">f&quot;Unknown line while parsing: <span class="subst">&#123;self._cur_line()&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.startswith(<span class="string">&quot;*** End Patch&quot;</span>):</span><br><span class="line">            <span class="keyword">raise</span> DiffError(<span class="string">&quot;Missing *** End Patch sentinel&quot;</span>)</span><br><span class="line">        self.index += <span class="number">1</span>  <span class="comment"># consume sentinel</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ------------- section parsers ---------------------------------------- #</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_parse_update_file</span>(<span class="params">self, text: <span class="built_in">str</span></span>) -&gt; PatchAction:</span><br><span class="line">        action = PatchAction(<span class="built_in">type</span>=ActionType.UPDATE)</span><br><span class="line">        lines = text.split(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        index = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> self.is_done(</span><br><span class="line">            (</span><br><span class="line">                <span class="string">&quot;*** End Patch&quot;</span>,</span><br><span class="line">                <span class="string">&quot;*** Update File:&quot;</span>,</span><br><span class="line">                <span class="string">&quot;*** Delete File:&quot;</span>,</span><br><span class="line">                <span class="string">&quot;*** Add File:&quot;</span>,</span><br><span class="line">                <span class="string">&quot;*** End of File&quot;</span>,</span><br><span class="line">            )</span><br><span class="line">        ):</span><br><span class="line">            def_str = self.read_str(<span class="string">&quot;@@ &quot;</span>)</span><br><span class="line">            section_str = <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> def_str <span class="keyword">and</span> self._norm(self._cur_line()) == <span class="string">&quot;@@&quot;</span>:</span><br><span class="line">                section_str = self.read_line()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> (def_str <span class="keyword">or</span> section_str <span class="keyword">or</span> index == <span class="number">0</span>):</span><br><span class="line">                <span class="keyword">raise</span> DiffError(<span class="string">f&quot;Invalid line in update section:\n<span class="subst">&#123;self._cur_line()&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> def_str.strip():</span><br><span class="line">                found = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">if</span> def_str <span class="keyword">not</span> <span class="keyword">in</span> lines[:index]:</span><br><span class="line">                    <span class="keyword">for</span> i, s <span class="keyword">in</span> <span class="built_in">enumerate</span>(lines[index:], index):</span><br><span class="line">                        <span class="keyword">if</span> s == def_str:</span><br><span class="line">                            index = i + <span class="number">1</span></span><br><span class="line">                            found = <span class="literal">True</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> found <span class="keyword">and</span> def_str.strip() <span class="keyword">not</span> <span class="keyword">in</span> [</span><br><span class="line">                    s.strip() <span class="keyword">for</span> s <span class="keyword">in</span> lines[:index]</span><br><span class="line">                ]:</span><br><span class="line">                    <span class="keyword">for</span> i, s <span class="keyword">in</span> <span class="built_in">enumerate</span>(lines[index:], index):</span><br><span class="line">                        <span class="keyword">if</span> s.strip() == def_str.strip():</span><br><span class="line">                            index = i + <span class="number">1</span></span><br><span class="line">                            self.fuzz += <span class="number">1</span></span><br><span class="line">                            found = <span class="literal">True</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            next_ctx, chunks, end_idx, eof = peek_next_section(self.lines, self.index)</span><br><span class="line">            new_index, fuzz = find_context(lines, next_ctx, index, eof)</span><br><span class="line">            <span class="keyword">if</span> new_index == -<span class="number">1</span>:</span><br><span class="line">                ctx_txt = <span class="string">&quot;\n&quot;</span>.join(next_ctx)</span><br><span class="line">                <span class="keyword">raise</span> DiffError(</span><br><span class="line">                    <span class="string">f&quot;Invalid <span class="subst">&#123;<span class="string">&#x27;EOF &#x27;</span> <span class="keyword">if</span> eof <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span>&#125;</span>context at <span class="subst">&#123;index&#125;</span>:\n<span class="subst">&#123;ctx_txt&#125;</span>&quot;</span></span><br><span class="line">                )</span><br><span class="line">            self.fuzz += fuzz</span><br><span class="line">            <span class="keyword">for</span> ch <span class="keyword">in</span> chunks:</span><br><span class="line">                ch.orig_index += new_index</span><br><span class="line">                action.chunks.append(ch)</span><br><span class="line">            index = new_index + <span class="built_in">len</span>(next_ctx)</span><br><span class="line">            self.index = end_idx</span><br><span class="line">        <span class="keyword">return</span> action</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_parse_add_file</span>(<span class="params">self</span>) -&gt; PatchAction:</span><br><span class="line">        lines: <span class="type">List</span>[<span class="built_in">str</span>] = []</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> self.is_done(</span><br><span class="line">            (<span class="string">&quot;*** End Patch&quot;</span>, <span class="string">&quot;*** Update File:&quot;</span>, <span class="string">&quot;*** Delete File:&quot;</span>, <span class="string">&quot;*** Add File:&quot;</span>)</span><br><span class="line">        ):</span><br><span class="line">            s = self.read_line()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> s.startswith(<span class="string">&quot;+&quot;</span>):</span><br><span class="line">                <span class="keyword">raise</span> DiffError(<span class="string">f&quot;Invalid Add File line (missing &#x27;+&#x27;): <span class="subst">&#123;s&#125;</span>&quot;</span>)</span><br><span class="line">            lines.append(s[<span class="number">1</span>:])  <span class="comment"># strip leading &#x27;+&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> PatchAction(<span class="built_in">type</span>=ActionType.ADD, new_file=<span class="string">&quot;\n&quot;</span>.join(lines))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --------------------------------------------------------------------------- #</span></span><br><span class="line"><span class="comment">#  Helper functions</span></span><br><span class="line"><span class="comment"># --------------------------------------------------------------------------- #</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_context_core</span>(<span class="params"></span></span><br><span class="line"><span class="params">    lines: <span class="type">List</span>[<span class="built_in">str</span>], context: <span class="type">List</span>[<span class="built_in">str</span>], start: <span class="built_in">int</span></span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>]:</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> context:</span><br><span class="line">        <span class="keyword">return</span> start, <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(start, <span class="built_in">len</span>(lines)):</span><br><span class="line">        <span class="keyword">if</span> lines[i : i + <span class="built_in">len</span>(context)] == context:</span><br><span class="line">            <span class="keyword">return</span> i, <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(start, <span class="built_in">len</span>(lines)):</span><br><span class="line">        <span class="keyword">if</span> [s.rstrip() <span class="keyword">for</span> s <span class="keyword">in</span> lines[i : i + <span class="built_in">len</span>(context)]] == [</span><br><span class="line">            s.rstrip() <span class="keyword">for</span> s <span class="keyword">in</span> context</span><br><span class="line">        ]:</span><br><span class="line">            <span class="keyword">return</span> i, <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(start, <span class="built_in">len</span>(lines)):</span><br><span class="line">        <span class="keyword">if</span> [s.strip() <span class="keyword">for</span> s <span class="keyword">in</span> lines[i : i + <span class="built_in">len</span>(context)]] == [</span><br><span class="line">            s.strip() <span class="keyword">for</span> s <span class="keyword">in</span> context</span><br><span class="line">        ]:</span><br><span class="line">            <span class="keyword">return</span> i, <span class="number">100</span></span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>, <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_context</span>(<span class="params"></span></span><br><span class="line"><span class="params">    lines: <span class="type">List</span>[<span class="built_in">str</span>], context: <span class="type">List</span>[<span class="built_in">str</span>], start: <span class="built_in">int</span>, eof: <span class="built_in">bool</span></span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>]:</span><br><span class="line">    <span class="keyword">if</span> eof:</span><br><span class="line">        new_index, fuzz = find_context_core(lines, context, <span class="built_in">len</span>(lines) - <span class="built_in">len</span>(context))</span><br><span class="line">        <span class="keyword">if</span> new_index != -<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> new_index, fuzz</span><br><span class="line">        new_index, fuzz = find_context_core(lines, context, start)</span><br><span class="line">        <span class="keyword">return</span> new_index, fuzz + <span class="number">10_000</span></span><br><span class="line">    <span class="keyword">return</span> find_context_core(lines, context, start)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">peek_next_section</span>(<span class="params"></span></span><br><span class="line"><span class="params">    lines: <span class="type">List</span>[<span class="built_in">str</span>], index: <span class="built_in">int</span></span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="type">Tuple</span>[<span class="type">List</span>[<span class="built_in">str</span>], <span class="type">List</span>[Chunk], <span class="built_in">int</span>, <span class="built_in">bool</span>]:</span><br><span class="line">    old: <span class="type">List</span>[<span class="built_in">str</span>] = []</span><br><span class="line">    del_lines: <span class="type">List</span>[<span class="built_in">str</span>] = []</span><br><span class="line">    ins_lines: <span class="type">List</span>[<span class="built_in">str</span>] = []</span><br><span class="line">    chunks: <span class="type">List</span>[Chunk] = []</span><br><span class="line">    mode = <span class="string">&quot;keep&quot;</span></span><br><span class="line">    orig_index = index</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> index &lt; <span class="built_in">len</span>(lines):</span><br><span class="line">        s = lines[index]</span><br><span class="line">        <span class="keyword">if</span> s.startswith(</span><br><span class="line">            (</span><br><span class="line">                <span class="string">&quot;@@&quot;</span>,</span><br><span class="line">                <span class="string">&quot;*** End Patch&quot;</span>,</span><br><span class="line">                <span class="string">&quot;*** Update File:&quot;</span>,</span><br><span class="line">                <span class="string">&quot;*** Delete File:&quot;</span>,</span><br><span class="line">                <span class="string">&quot;*** Add File:&quot;</span>,</span><br><span class="line">                <span class="string">&quot;*** End of File&quot;</span>,</span><br><span class="line">            )</span><br><span class="line">        ):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> s == <span class="string">&quot;***&quot;</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> s.startswith(<span class="string">&quot;***&quot;</span>):</span><br><span class="line">            <span class="keyword">raise</span> DiffError(<span class="string">f&quot;Invalid Line: <span class="subst">&#123;s&#125;</span>&quot;</span>)</span><br><span class="line">        index += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        last_mode = mode</span><br><span class="line">        <span class="keyword">if</span> s == <span class="string">&quot;&quot;</span>:</span><br><span class="line">            s = <span class="string">&quot; &quot;</span></span><br><span class="line">        <span class="keyword">if</span> s[<span class="number">0</span>] == <span class="string">&quot;+&quot;</span>:</span><br><span class="line">            mode = <span class="string">&quot;add&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> s[<span class="number">0</span>] == <span class="string">&quot;-&quot;</span>:</span><br><span class="line">            mode = <span class="string">&quot;delete&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> s[<span class="number">0</span>] == <span class="string">&quot; &quot;</span>:</span><br><span class="line">            mode = <span class="string">&quot;keep&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> DiffError(<span class="string">f&quot;Invalid Line: <span class="subst">&#123;s&#125;</span>&quot;</span>)</span><br><span class="line">        s = s[<span class="number">1</span>:]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> mode == <span class="string">&quot;keep&quot;</span> <span class="keyword">and</span> last_mode != mode:</span><br><span class="line">            <span class="keyword">if</span> ins_lines <span class="keyword">or</span> del_lines:</span><br><span class="line">                chunks.append(</span><br><span class="line">                    Chunk(</span><br><span class="line">                        orig_index=<span class="built_in">len</span>(old) - <span class="built_in">len</span>(del_lines),</span><br><span class="line">                        del_lines=del_lines,</span><br><span class="line">                        ins_lines=ins_lines,</span><br><span class="line">                    )</span><br><span class="line">                )</span><br><span class="line">            del_lines, ins_lines = [], []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> mode == <span class="string">&quot;delete&quot;</span>:</span><br><span class="line">            del_lines.append(s)</span><br><span class="line">            old.append(s)</span><br><span class="line">        <span class="keyword">elif</span> mode == <span class="string">&quot;add&quot;</span>:</span><br><span class="line">            ins_lines.append(s)</span><br><span class="line">        <span class="keyword">elif</span> mode == <span class="string">&quot;keep&quot;</span>:</span><br><span class="line">            old.append(s)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ins_lines <span class="keyword">or</span> del_lines:</span><br><span class="line">        chunks.append(</span><br><span class="line">            Chunk(</span><br><span class="line">                orig_index=<span class="built_in">len</span>(old) - <span class="built_in">len</span>(del_lines),</span><br><span class="line">                del_lines=del_lines,</span><br><span class="line">                ins_lines=ins_lines,</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> index &lt; <span class="built_in">len</span>(lines) <span class="keyword">and</span> lines[index] == <span class="string">&quot;*** End of File&quot;</span>:</span><br><span class="line">        index += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> old, chunks, index, <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> index == orig_index:</span><br><span class="line">        <span class="keyword">raise</span> DiffError(<span class="string">&quot;Nothing in this section&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> old, chunks, index, <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --------------------------------------------------------------------------- #</span></span><br><span class="line"><span class="comment">#  Patch → Commit and Commit application</span></span><br><span class="line"><span class="comment"># --------------------------------------------------------------------------- #</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_get_updated_file</span>(<span class="params">text: <span class="built_in">str</span>, action: PatchAction, path: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="keyword">if</span> action.<span class="built_in">type</span> <span class="keyword">is</span> <span class="keyword">not</span> ActionType.UPDATE:</span><br><span class="line">        <span class="keyword">raise</span> DiffError(<span class="string">&quot;_get_updated_file called with non-update action&quot;</span>)</span><br><span class="line">    orig_lines = text.split(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    dest_lines: <span class="type">List</span>[<span class="built_in">str</span>] = []</span><br><span class="line">    orig_index = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> chunk <span class="keyword">in</span> action.chunks:</span><br><span class="line">        <span class="keyword">if</span> chunk.orig_index &gt; <span class="built_in">len</span>(orig_lines):</span><br><span class="line">            <span class="keyword">raise</span> DiffError(</span><br><span class="line">                <span class="string">f&quot;<span class="subst">&#123;path&#125;</span>: chunk.orig_index <span class="subst">&#123;chunk.orig_index&#125;</span> exceeds file length&quot;</span></span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">if</span> orig_index &gt; chunk.orig_index:</span><br><span class="line">            <span class="keyword">raise</span> DiffError(</span><br><span class="line">                <span class="string">f&quot;<span class="subst">&#123;path&#125;</span>: overlapping chunks at <span class="subst">&#123;orig_index&#125;</span> &gt; <span class="subst">&#123;chunk.orig_index&#125;</span>&quot;</span></span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        dest_lines.extend(orig_lines[orig_index : chunk.orig_index])</span><br><span class="line">        orig_index = chunk.orig_index</span><br><span class="line"></span><br><span class="line">        dest_lines.extend(chunk.ins_lines)</span><br><span class="line">        orig_index += <span class="built_in">len</span>(chunk.del_lines)</span><br><span class="line"></span><br><span class="line">    dest_lines.extend(orig_lines[orig_index:])</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;\n&quot;</span>.join(dest_lines)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">patch_to_commit</span>(<span class="params">patch: Patch, orig: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>]</span>) -&gt; Commit:</span><br><span class="line">    commit = Commit()</span><br><span class="line">    <span class="keyword">for</span> path, action <span class="keyword">in</span> patch.actions.items():</span><br><span class="line">        <span class="keyword">if</span> action.<span class="built_in">type</span> <span class="keyword">is</span> ActionType.DELETE:</span><br><span class="line">            commit.changes[path] = FileChange(</span><br><span class="line">                <span class="built_in">type</span>=ActionType.DELETE, old_content=orig[path]</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">elif</span> action.<span class="built_in">type</span> <span class="keyword">is</span> ActionType.ADD:</span><br><span class="line">            <span class="keyword">if</span> action.new_file <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">raise</span> DiffError(<span class="string">&quot;ADD action without file content&quot;</span>)</span><br><span class="line">            commit.changes[path] = FileChange(</span><br><span class="line">                <span class="built_in">type</span>=ActionType.ADD, new_content=action.new_file</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">elif</span> action.<span class="built_in">type</span> <span class="keyword">is</span> ActionType.UPDATE:</span><br><span class="line">            new_content = _get_updated_file(orig[path], action, path)</span><br><span class="line">            commit.changes[path] = FileChange(</span><br><span class="line">                <span class="built_in">type</span>=ActionType.UPDATE,</span><br><span class="line">                old_content=orig[path],</span><br><span class="line">                new_content=new_content,</span><br><span class="line">                move_path=action.move_path,</span><br><span class="line">            )</span><br><span class="line">    <span class="keyword">return</span> commit</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --------------------------------------------------------------------------- #</span></span><br><span class="line"><span class="comment">#  User-facing helpers</span></span><br><span class="line"><span class="comment"># --------------------------------------------------------------------------- #</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">text_to_patch</span>(<span class="params">text: <span class="built_in">str</span>, orig: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>]</span>) -&gt; <span class="type">Tuple</span>[Patch, <span class="built_in">int</span>]:</span><br><span class="line">    lines = text.splitlines()  <span class="comment"># preserves blank lines, no strip()</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        <span class="built_in">len</span>(lines) &lt; <span class="number">2</span></span><br><span class="line">        <span class="keyword">or</span> <span class="keyword">not</span> Parser._norm(lines[<span class="number">0</span>]).startswith(<span class="string">&quot;*** Begin Patch&quot;</span>)</span><br><span class="line">        <span class="keyword">or</span> Parser._norm(lines[-<span class="number">1</span>]) != <span class="string">&quot;*** End Patch&quot;</span></span><br><span class="line">    ):</span><br><span class="line">        <span class="keyword">raise</span> DiffError(<span class="string">&quot;Invalid patch text - missing sentinels&quot;</span>)</span><br><span class="line"></span><br><span class="line">    parser = Parser(current_files=orig, lines=lines, index=<span class="number">1</span>)</span><br><span class="line">    parser.parse()</span><br><span class="line">    <span class="keyword">return</span> parser.patch, parser.fuzz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">identify_files_needed</span>(<span class="params">text: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">str</span>]:</span><br><span class="line">    lines = text.splitlines()</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        line[<span class="built_in">len</span>(<span class="string">&quot;*** Update File: &quot;</span>) :]</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> lines</span><br><span class="line">        <span class="keyword">if</span> line.startswith(<span class="string">&quot;*** Update File: &quot;</span>)</span><br><span class="line">    ] + [</span><br><span class="line">        line[<span class="built_in">len</span>(<span class="string">&quot;*** Delete File: &quot;</span>) :]</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> lines</span><br><span class="line">        <span class="keyword">if</span> line.startswith(<span class="string">&quot;*** Delete File: &quot;</span>)</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">identify_files_added</span>(<span class="params">text: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">str</span>]:</span><br><span class="line">    lines = text.splitlines()</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        line[<span class="built_in">len</span>(<span class="string">&quot;*** Add File: &quot;</span>) :]</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> lines</span><br><span class="line">        <span class="keyword">if</span> line.startswith(<span class="string">&quot;*** Add File: &quot;</span>)</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --------------------------------------------------------------------------- #</span></span><br><span class="line"><span class="comment">#  File-system helpers</span></span><br><span class="line"><span class="comment"># --------------------------------------------------------------------------- #</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_files</span>(<span class="params">paths: <span class="type">List</span>[<span class="built_in">str</span>], open_fn: <span class="type">Callable</span>[[<span class="built_in">str</span>], <span class="built_in">str</span>]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>]:</span><br><span class="line">    <span class="keyword">return</span> &#123;path: open_fn(path) <span class="keyword">for</span> path <span class="keyword">in</span> paths&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">apply_commit</span>(<span class="params"></span></span><br><span class="line"><span class="params">    commit: Commit,</span></span><br><span class="line"><span class="params">    write_fn: <span class="type">Callable</span>[[<span class="built_in">str</span>, <span class="built_in">str</span>], <span class="literal">None</span>],</span></span><br><span class="line"><span class="params">    remove_fn: <span class="type">Callable</span>[[<span class="built_in">str</span>], <span class="literal">None</span>],</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">for</span> path, change <span class="keyword">in</span> commit.changes.items():</span><br><span class="line">        <span class="keyword">if</span> change.<span class="built_in">type</span> <span class="keyword">is</span> ActionType.DELETE:</span><br><span class="line">            remove_fn(path)</span><br><span class="line">        <span class="keyword">elif</span> change.<span class="built_in">type</span> <span class="keyword">is</span> ActionType.ADD:</span><br><span class="line">            <span class="keyword">if</span> change.new_content <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">raise</span> DiffError(<span class="string">f&quot;ADD change for <span class="subst">&#123;path&#125;</span> has no content&quot;</span>)</span><br><span class="line">            write_fn(path, change.new_content)</span><br><span class="line">        <span class="keyword">elif</span> change.<span class="built_in">type</span> <span class="keyword">is</span> ActionType.UPDATE:</span><br><span class="line">            <span class="keyword">if</span> change.new_content <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">raise</span> DiffError(<span class="string">f&quot;UPDATE change for <span class="subst">&#123;path&#125;</span> has no new content&quot;</span>)</span><br><span class="line">            target = change.move_path <span class="keyword">or</span> path</span><br><span class="line">            write_fn(target, change.new_content)</span><br><span class="line">            <span class="keyword">if</span> change.move_path:</span><br><span class="line">                remove_fn(path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_patch</span>(<span class="params"></span></span><br><span class="line"><span class="params">    text: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">    open_fn: <span class="type">Callable</span>[[<span class="built_in">str</span>], <span class="built_in">str</span>],</span></span><br><span class="line"><span class="params">    write_fn: <span class="type">Callable</span>[[<span class="built_in">str</span>, <span class="built_in">str</span>], <span class="literal">None</span>],</span></span><br><span class="line"><span class="params">    remove_fn: <span class="type">Callable</span>[[<span class="built_in">str</span>], <span class="literal">None</span>],</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> text.startswith(<span class="string">&quot;*** Begin Patch&quot;</span>):</span><br><span class="line">        <span class="keyword">raise</span> DiffError(<span class="string">&quot;Patch text must start with *** Begin Patch&quot;</span>)</span><br><span class="line">    paths = identify_files_needed(text)</span><br><span class="line">    orig = load_files(paths, open_fn)</span><br><span class="line">    patch, _fuzz = text_to_patch(text, orig)</span><br><span class="line">    commit = patch_to_commit(patch, orig)</span><br><span class="line">    apply_commit(commit, write_fn, remove_fn)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Done!&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --------------------------------------------------------------------------- #</span></span><br><span class="line"><span class="comment">#  Default FS helpers</span></span><br><span class="line"><span class="comment"># --------------------------------------------------------------------------- #</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">open_file</span>(<span class="params">path: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&quot;rt&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> fh:</span><br><span class="line">        <span class="keyword">return</span> fh.read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_file</span>(<span class="params">path: <span class="built_in">str</span>, content: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    target = pathlib.Path(path)</span><br><span class="line">    target.parent.mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">with</span> target.<span class="built_in">open</span>(<span class="string">&quot;wt&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> fh:</span><br><span class="line">        fh.write(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">remove_file</span>(<span class="params">path: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    pathlib.Path(path).unlink(missing_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --------------------------------------------------------------------------- #</span></span><br><span class="line"><span class="comment">#  CLI entry-point</span></span><br><span class="line"><span class="comment"># --------------------------------------------------------------------------- #</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>() -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">    patch_text = sys.stdin.read()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> patch_text:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Please pass patch text through stdin&quot;</span>, file=sys.stderr)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = process_patch(patch_text, open_file, write_file, remove_file)</span><br><span class="line">    <span class="keyword">except</span> DiffError <span class="keyword">as</span> exc:</span><br><span class="line">        <span class="built_in">print</span>(exc, file=sys.stderr)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h3 id="其他有效的-Diff-格式"><a href="#其他有效的-Diff-格式" class="headerlink" title="其他有效的 Diff 格式"></a>其他有效的 Diff 格式</h3><p>如果你想尝试使用不同的 diff 格式，我们在测试中发现，Aider 的 polyglot 基准测试中使用的 SEARCH&#x2F;REPLACE（查找&#x2F;替换）diff 格式，以及一种没有内部转义的伪 XML 格式，都有很高的成功率。</p>
<p>这些 diff 格式有两个关键共同点：（1）它们不使用行号；（2）它们都明确提供了需要被替换的精确代码和用于替换的新代码，并且两者之间有清晰的分隔符。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">SEARCH_REPLACE_DIFF_EXAMPLE = &quot;&quot;&quot;</span><br><span class="line">path/to/file.py</span><br><span class="line">```</span><br><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt; SEARCH</span><br><span class="line">def search():</span><br><span class="line">    pass</span><br><span class="line">=======</span><br><span class="line">def search():</span><br><span class="line">   raise NotImplementedError()</span><br><span class="line">&lt;&lt;&lt;&lt;&lt;&lt;&lt; REPLACE</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">PSEUDO_XML_DIFF_EXAMPLE = &quot;&quot;&quot;</span><br><span class="line">&lt;edit&gt;</span><br><span class="line">&lt;file&gt;</span><br><span class="line">path/to/file.py</span><br><span class="line">&lt;/file&gt;</span><br><span class="line">&lt;old_code&gt;</span><br><span class="line">def search():</span><br><span class="line">    pass</span><br><span class="line">&lt;/old_code&gt;</span><br><span class="line">&lt;new_code&gt;</span><br><span class="line">def search():</span><br><span class="line">   raise NotImplementedError()</span><br><span class="line">&lt;/new_code&gt;</span><br><span class="line">&lt;/edit&gt;</span><br><span class="line">&quot;&quot;&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>本文由AI生成，内容仅供参考。在实际部署前，请根据具体环境进行测试和验证。</p>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://xhua.eu.org">Michael Pan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://xhua.eu.org/AI/GPT-4.1%E6%8F%90%E7%A4%BA%E6%8C%87%E5%8D%97%EF%BC%88%E7%BF%BB%E8%AF%91%EF%BC%89/">https://xhua.eu.org/AI/GPT-4.1%E6%8F%90%E7%A4%BA%E6%8C%87%E5%8D%97%EF%BC%88%E7%BF%BB%E8%AF%91%EF%BC%89/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://xhua.eu.org" target="_blank">Michael Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/MCP/">MCP</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/xhuaustc/images@main/a5bc40e344df82a2633906aa04eb55447b0890a6c2dacf23b585537f4838f7e4.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/AI/Cursor%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AApython%E9%A1%B9%E7%9B%AE%E7%9A%84%E6%89%80%E6%9C%89%E4%BA%A4%E4%BA%92/" title="Cursor创建一个python项目的所有交互"><img class="cover" src="https://cdn.jsdelivr.net/gh/xhuaustc/images@main/d1245375296649146ee3ca43fcaa518ca98a923c8d836383cb19550a574ec9cf.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Cursor创建一个python项目的所有交互</div></div></a></div><div class="next-post pull-right"><a href="/openshift/Argo-Rollouts%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97%EF%BC%9AKubernetes%E9%AB%98%E7%BA%A7%E9%83%A8%E7%BD%B2%E7%AD%96%E7%95%A5%E8%AF%A6%E8%A7%A3/" title="Argo Rollouts使用指南：Kubernetes高级部署策略详解"><img class="cover" src="https://cdn.jsdelivr.net/gh/xhuaustc/images@main/65d68aee408035584ccb994bd2f56a4200fb6ab76c8ac149bc7ebfd1f904a7e6.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Argo Rollouts使用指南：Kubernetes高级部署策略详解</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/AI/SRE%20MCP%20Tools%EF%BC%9A%E8%BF%90%E7%BB%B4%E5%B7%A5%E7%A8%8B%E5%B8%88%E7%9A%84AI%E5%8A%A9%E6%89%8B%E5%B7%A5%E5%85%B7%E7%AE%B1/" title="SRE MCP Tools：运维工程师的AI助手工具箱"><img class="cover" src="https://cdn.jsdelivr.net/gh/xhuaustc/images@main/e16beb5e1fd69876853b76d350682f3eb62d53d60bd29d2b5dd0307b1bb62f80.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-03</div><div class="title">SRE MCP Tools：运维工程师的AI助手工具箱</div></div></a></div><div><a href="/AI/%E4%BD%BF%E7%94%A8python%E5%BC%80%E5%8F%91%E8%87%AA%E5%B7%B1%E7%9A%84MCP/" title="使用Python开发自己的MCP服务：AI能力扩展入门指南"><img class="cover" src="https://cdn.jsdelivr.net/gh/xhuaustc/images@main/008ff9056c7bc3e71e6323c85ba989ef9a03524b0b5ffd578e82618c4dceded2.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-16</div><div class="title">使用Python开发自己的MCP服务：AI能力扩展入门指南</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E4%BB%A3%E7%90%86%E5%B7%A5%E4%BD%9C%E6%B5%81"><span class="toc-text">1. 代理工作流</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E6%8F%90%E7%A4%BA%E6%8F%90%E9%86%92"><span class="toc-text">系统提示提醒</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E8%B0%83%E7%94%A8"><span class="toc-text">工具调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E7%A4%BA%E8%AF%B1%E5%AF%BC%E8%A7%84%E5%88%92%E5%92%8C%E6%80%9D%E7%BB%B4%E9%93%BE"><span class="toc-text">提示诱导规划和思维链</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E6%8F%90%E7%A4%BA%EF%BC%9ASWE-bench-Verified"><span class="toc-text">示例提示：SWE-bench Verified</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E9%95%BF%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-text">2. 长上下文</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E4%BD%B3%E4%B8%8A%E4%B8%8B%E6%96%87%E5%A4%A7%E5%B0%8F"><span class="toc-text">最佳上下文大小</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E6%95%B4%E4%B8%8A%E4%B8%8B%E6%96%87%E4%BE%9D%E8%B5%96"><span class="toc-text">调整上下文依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E7%A4%BA%E7%BB%84%E7%BB%87"><span class="toc-text">提示组织</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%80%9D%E7%BB%B4%E9%93%BE"><span class="toc-text">3. 思维链</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%8C%87%E4%BB%A4%E9%81%B5%E5%BE%AA"><span class="toc-text">4. 指令遵循</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E4%B8%80%E8%88%AC%E5%BB%BA%E8%AE%AE"><span class="toc-text">5. 一般建议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E7%A4%BA%E7%BB%93%E6%9E%84"><span class="toc-text">提示结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E9%9A%94%E7%AC%A6"><span class="toc-text">分隔符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-text">注意事项</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E5%BD%95%EF%BC%9A%E7%94%9F%E6%88%90%E5%92%8C%E5%BA%94%E7%94%A8%E6%96%87%E4%BB%B6%E5%B7%AE%E5%BC%82"><span class="toc-text">附录：生成和应用文件差异</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E8%A1%A5%E4%B8%81"><span class="toc-text">应用补丁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E5%AE%9E%E7%8E%B0%EF%BC%9Aapply-patch-py"><span class="toc-text">参考实现：apply_patch.py</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%9C%89%E6%95%88%E7%9A%84-Diff-%E6%A0%BC%E5%BC%8F"><span class="toc-text">其他有效的 Diff 格式</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.jsdelivr.net/gh/xhuaustc/images@main/a5bc40e344df82a2633906aa04eb55447b0890a6c2dacf23b585537f4838f7e4.png')"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By Michael Pan</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: 'bd411f7fab0148676434',
      clientSecret: 'c428724cacf9b34ab17326dec6d6e8a2e23b6c15',
      repo: 'xhuaustc.github.io',
      owner: 'xhuaustc',
      admin: ['xhuaustc'],
      id: '2c3fa500953a48acdacc7bf1904087ac',
      updateCountCallback: commentCount
    },{"language":"zh-CN"}))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
    getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.textContent= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>