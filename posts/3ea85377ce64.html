<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>《Prometheus监控实战》读书笔记 | Michael Blog</title><meta name="author" content="Michael Pan"><meta name="copyright" content="Michael Pan"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Prometheus是一个开源的监控系统。   一、监控简介监控不仅仅只是系统的技术指标，还可以是业务指标。确保为客户提供可靠恰当的产品。在生产系统中，监控是必须的，它应该和应用程序一起构建和部署。帮助我们了解系统的环境、进行诊断故障、制定容量计划，为组织提供系统的性能、成本和状态等信息。 监控模式 务必在项目最开始阶段就把监控考虑进去，它和安全性一样，都是应用的核心功能。 根据服务价值设计">
<meta property="og:type" content="article">
<meta property="og:title" content="《Prometheus监控实战》读书笔记">
<meta property="og:url" content="https://xhua.eu.org/posts/3ea85377ce64.html">
<meta property="og:site_name" content="Michael Blog">
<meta property="og:description" content="Prometheus是一个开源的监控系统。   一、监控简介监控不仅仅只是系统的技术指标，还可以是业务指标。确保为客户提供可靠恰当的产品。在生产系统中，监控是必须的，它应该和应用程序一起构建和部署。帮助我们了解系统的环境、进行诊断故障、制定容量计划，为组织提供系统的性能、成本和状态等信息。 监控模式 务必在项目最开始阶段就把监控考虑进去，它和安全性一样，都是应用的核心功能。 根据服务价值设计">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img.xhua.eu.org/8a25a774e85f4cee5a52f1b5a1866767ea695e09b6e57370d72b1a7bd0bc7e5f.jpg">
<meta property="article:published_time" content="2020-05-20T12:30:00.000Z">
<meta property="article:modified_time" content="2026-02-24T07:27:54.643Z">
<meta property="article:author" content="Michael Pan">
<meta property="article:tag" content="monitor">
<meta property="article:tag" content="openshift">
<meta property="article:tag" content="读书笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img.xhua.eu.org/8a25a774e85f4cee5a52f1b5a1866767ea695e09b6e57370d72b1a7bd0bc7e5f.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "《Prometheus监控实战》读书笔记",
  "url": "https://xhua.eu.org/posts/3ea85377ce64.html",
  "image": "https://img.xhua.eu.org/8a25a774e85f4cee5a52f1b5a1866767ea695e09b6e57370d72b1a7bd0bc7e5f.jpg",
  "datePublished": "2020-05-20T12:30:00.000Z",
  "dateModified": "2026-02-24T07:27:54.643Z",
  "author": [
    {
      "@type": "Person",
      "name": "Michael Pan",
      "url": "https://xhua.eu.org"
    }
  ]
}</script><link rel="shortcut icon" href="https://img.xhua.eu.org/ee7822a9c1b896de5649988ed5a9dc89c8f46fb54dd442f2d9c74721a05fa708.jpg"><link rel="canonical" href="https://xhua.eu.org/posts/3ea85377ce64.html"><link rel="preconnect"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/pluginsSrc/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"pagination":{"enable":false,"hitsPerPage":8},"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: '/pluginsSrc/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '《Prometheus监控实战》读书笔记',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/preloader-frosted-glass.css"><meta name="generator" content="Hexo 8.1.1"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      if ($loadingBox.classList.contains('loaded')) return
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()

  if (document.readyState === 'complete') {
    preloader.endLoading()
  } else {
    window.addEventListener('load', preloader.endLoading)
    document.addEventListener('DOMContentLoaded', preloader.endLoading)
    // Add timeout protection: force end after 7 seconds
    setTimeout(preloader.endLoading, 7000)
  }

  if (false) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://img.xhua.eu.org/87ab7c10242ff1ab32f46f7c7b335d0581d3885fa40b8e3dc1d97014e67ea56d.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">264</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">121</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">14</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(https://img.xhua.eu.org/8a25a774e85f4cee5a52f1b5a1866767ea695e09b6e57370d72b1a7bd0bc7e5f.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Michael Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">《Prometheus监控实战》读书笔记</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">《Prometheus监控实战》读书笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-05-20T12:30:00.000Z" title="发表于 2020-05-20 20:30:00">2020-05-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-02-24T07:27:54.643Z" title="更新于 2026-02-24 15:27:54">2026-02-24</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/openshift/">openshift</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><p><img src="https://img.xhua.eu.org/8a25a774e85f4cee5a52f1b5a1866767ea695e09b6e57370d72b1a7bd0bc7e5f.jpg" alt="《Prometheus监控实战》">  </p>
<p>Prometheus是一个开源的监控系统。<br><img src="https://img.xhua.eu.org/1f8a3c449d01077883005884a31996646634a14c3d8dc713bf627d7e90f893a1.jpg" alt="Prometheus架构">  </p>
<h1 id="一、监控简介"><a href="#一、监控简介" class="headerlink" title="一、监控简介"></a>一、监控简介</h1><p>监控不仅仅只是系统的技术指标，还可以是业务指标。确保为客户提供可靠恰当的产品。<br>在生产系统中，监控是必须的，它应该和应用程序一起构建和部署。帮助我们了解系统的环境、进行诊断故障、制定容量计划，为组织提供系统的性能、成本和状态等信息。</p>
<h2 id="监控模式"><a href="#监控模式" class="headerlink" title="监控模式"></a>监控模式</h2><ol>
<li>务必在项目最开始阶段就把监控考虑进去，它和安全性一样，都是应用的核心功能。</li>
<li>根据服务价值设计自上而下的监控系统是一个很好的方式。先是业务逻辑，再是应用程序，最后才是基础设施操作系统。</li>
<li>需要找准监控项，及时发现错误</li>
<li>通过多样化的数据，如查看数据窗口等更智能的技术分析指标与阀值</li>
<li>增加监控的频率</li>
<li>尽可能实现监控系统部署实施自动化</li>
</ol>
<h2 id="监控机制"><a href="#监控机制" class="headerlink" title="监控机制"></a>监控机制</h2><ol>
<li>探针与内省：监控应用程序的两种方法。<br>探针：在应用程序的外部，查询应用程序的外部特征。如Nagios。<br>内省：查看应用程序的内部内容，经过检测，返回其状态、内部组件等的度量。可用作健康检查接口，由监控工具收集。</li>
<li>拉取与推送：执行监控检查的两种方式。<br>拉取：提取或检查远程应用程序。如Prometheus。<br>推送：应用程序发送事件给监控系统接收。</li>
</ol>
<h2 id="监控数据类型"><a href="#监控数据类型" class="headerlink" title="监控数据类型"></a>监控数据类型</h2><ol>
<li>指标：软件和硬件组件属性的度量。<br>指标类型：测量型 <code>Gauge</code>、计数型 <code>Counter</code>、直方图 <code>Histogram</code></li>
<li>日志：应用程序发出的事件（通常是文本类型）。</li>
</ol>
<h2 id="监控方法论"><a href="#监控方法论" class="headerlink" title="监控方法论"></a>监控方法论</h2><ol>
<li>Brendan Gregg的USE方法 <code>主机级监控</code><br>USE：使用率、饱和度、错误。针对每个资源（如CPU），检查使用率（如CPU使用百分比）、饱和度（如等待CPU的进程数）和错误（如错误事件的计数）。</li>
<li>Google四个黄金指标 <code>应用程序级监控</code><br>延迟（如服务请求时间）、流量（如每秒HTTP请求数）、错误（如响应时间走过30ms的请求视为错误）、饱和度（如内存IO）。</li>
<li>RED方法<br>Rate（你的服务所服务的每秒的请求数）、Errors（每秒失败的请求数）、Duration（每个请求所花费的时间，用时间间隔表示）</li>
</ol>
<h2 id="通知系统"><a href="#通知系统" class="headerlink" title="通知系统"></a>通知系统</h2><p>通知系统需要关注以下几点：</p>
<ol>
<li>通知清晰、准确、可操作。人易读。</li>
<li>通知添加上下文，通知应包含组件的其他相关信息。</li>
<li>仅发送有意义的通知。</li>
</ol>
<h1 id="二、Prometheus是什么？"><a href="#二、Prometheus是什么？" class="headerlink" title="二、Prometheus是什么？"></a>二、Prometheus是什么？</h1><p>Prometheus灵感来自于谷歌的Borgmon。这由前谷歌SRE Matt T. Proud开发。Proud加入SoundCloud后，两天Julius Volz合作开发了Prometheus。于2015年1月发布。<br>Prometheus主要用于提供近实时的、基于动态云环境和容器的微服务、服务和应用的内省监控。Prometheus专注于当前的事件，大多数监控查询和警报都是从最近（通常为一天内）的数据中生成。<br>Prometheus通过拉取应用程序中暴露的时间序列数据来工作。时间序列数据通常由应用程序本身通过客户端库或exporter的代理来作为HTTP端点暴露。</p>
<h2 id="Prometheus架构"><a href="#Prometheus架构" class="headerlink" title="Prometheus架构"></a>Prometheus架构</h2><p>Prometheus有一个推送网关，可用于接收少量数据。<br><img src="https://img.xhua.eu.org/7311a0c938a022433533fcbd789eb208c964029b829002fad40759079fdc7cff.jpg" alt="Prometheus架构">  </p>
<h3 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h3><p>endpoint：端点，Prometheus抓取的指标来源<br>target：目标，定义执行抓取所需的信息，如链接，身份验证，抓取方式<br>job：一组目标，具有相同角色的目标组</p>
<h3 id="监控资源服务发现"><a href="#监控资源服务发现" class="headerlink" title="监控资源服务发现"></a>监控资源服务发现</h3><ol>
<li>用户提供静态资源列表。</li>
<li>基于文件的发现。例如使用配置管理工具生成在Prometheus中可以自动更新的资源列表。</li>
<li>自动发现。例如，查询consule等数据存储。</li>
</ol>
<h3 id="聚合和警报"><a href="#聚合和警报" class="headerlink" title="聚合和警报"></a>聚合和警报</h3><p>Prometheus服务器可以查询和聚合时间序列数据，创建规则来记录常用的查询和聚合。<br>Prometheus可以定义警报规则。为系统配置的在满足条件时触发警报的标准。将警报从Prometheus推送到警报管理器（Alertmanager）的单独服务器。<br>AlertManager可以管理、整合、分发各种警报到不同的目的地。</p>
<h3 id="查询、可视化"><a href="#查询、可视化" class="headerlink" title="查询、可视化"></a>查询、可视化</h3><p>Prometheus提供了一套内置查询语言PromQL、一个表达式浏览器及浏览数据的图形界面。<br>Prometheus可以与开源DashBoard Grafana集成，同时也支持其他的DashBoard。<br><code>为了速度与可靠性，Prometheus服务器充分使用内存和SSD磁盘</code></p>
<h3 id="冗余和高可用性"><a href="#冗余和高可用性" class="headerlink" title="冗余和高可用性"></a>冗余和高可用性</h3><p>部署Prometheus的高可用模式，可以使用两个以上配置相同的Prometheus服务器来收集时间序列数据，并且生成的警报由Alertmanager集群来处理。</p>
<h3 id="Prometheus数据模型"><a href="#Prometheus数据模型" class="headerlink" title="Prometheus数据模型"></a>Prometheus数据模型</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">total_website_visits&#123;site=&quot;MegaApp&quot;, location=&quot;NJ&quot;, instance=&quot;webserver:9090&quot;, job=&quot;web&quot;&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>指标名称：total_website</li>
<li>标签：site&#x3D;”MegaApp”等，通常都有一个instance标签和job标签<br>标签分为两类：1，插桩标签；2，目标标签<br>插桩标签：来自被监控的资源<br>目标标签：通常与架构相关，由Prometheus在抓取期间和之后添加。</li>
<li>时间序列由名称和标签标识，如果在时间序列中添加或更改标签，Prometheus会将其视为新的时间序列。</li>
</ul>
<h1 id="三、安装部署Prometheus"><a href="#三、安装部署Prometheus" class="headerlink" title="三、安装部署Prometheus"></a>三、安装部署Prometheus</h1><h2 id="安装Prometheus"><a href="#安装Prometheus" class="headerlink" title="安装Prometheus"></a>安装Prometheus</h2><h3 id="Linux上安装Prometheus"><a href="#Linux上安装Prometheus" class="headerlink" title="Linux上安装Prometheus"></a>Linux上安装Prometheus</h3><ol>
<li>下载Prometheus的二进制文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget https://github.com/prometheus/prometheus/releases/download/v2.14.0/prometheus-2.14.0.linux-amd64.tar.gz</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>解压文件到相关目录，安装promtool</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tar -xzf prometheus-2.14.0.linux-amd64.tar.gz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">cp</span> prometheus-2.14.0.linux-amd64/prometheus /usr/local/bin/</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">cp</span> prometheus-2.14.0.linux-amd64/promtool /usr/local/bin/</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>执行prometheus –version查看版本验证安装。</li>
</ol>
<h3 id="Ansible安装Promethues"><a href="#Ansible安装Promethues" class="headerlink" title="Ansible安装Promethues"></a>Ansible安装Promethues</h3><p>相关的role路径为：<a target="_blank" rel="noopener" href="https://github.com/cloudalchemy/ansible-prometheus">https://github.com/cloudalchemy/ansible-prometheus</a>。</p>
<h3 id="OpenShift上安装Prometheus"><a href="#OpenShift上安装Prometheus" class="headerlink" title="OpenShift上安装Prometheus"></a>OpenShift上安装Prometheus</h3><p>OpenShift官方部署脚本支持Prometheus的安装。在OpenShift 3.11部署的时候，prometheus默认是安装的，如果要禁止安装则需将inventory中的配置<code>openshift_cluster_monitoring_operator_install</code>设置为<code>false</code>。<br>相关的开源软件地址为：<a target="_blank" rel="noopener" href="https://github.com/openshift/cluster-monitoring-operator">https://github.com/openshift/cluster-monitoring-operator</a></p>
<h2 id="配置Prometheus"><a href="#配置Prometheus" class="headerlink" title="配置Prometheus"></a>配置Prometheus</h2><p>Prometheus通过YAML文件来配置。Prometheus的解压的目录中自带有配置文件prometheus.yml。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  scrape_interval:     15s # 应用程序或服务抓取数据的时间间隔，默认为1min</span><br><span class="line">  evaluation_interval: 15s # Prometheus评估规则（记录规则、警报规则）的频率，默认为1min</span><br><span class="line">  # scrape_timeout is set to the global default (10s).</span><br><span class="line"></span><br><span class="line"># Alertmanager configuration</span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">      # - alertmanager:9093</span><br><span class="line"></span><br><span class="line"># 一次性加载规则，并且每隔evaluation_interval时间对规则进行评估&#x27;evaluation_interval&#x27;.</span><br><span class="line">rule_files:</span><br><span class="line">  # - &quot;first_rules.yml&quot;</span><br><span class="line">  # - &quot;second_rules.yml&quot;</span><br><span class="line"></span><br><span class="line"># 指定Prometheus抓取的所有目标</span><br><span class="line"># 下面是监控Prometheus本身</span><br><span class="line">scrape_configs:</span><br><span class="line">  # job名字将会被加到监控的指标中`job=&lt;job_name&gt;` </span><br><span class="line">  - job_name: &#x27;prometheus&#x27;</span><br><span class="line"></span><br><span class="line">    # metrics_path 默认为 &#x27;/metrics&#x27;</span><br><span class="line">    # scheme 默认为 &#x27;http&#x27;.</span><br><span class="line"></span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [&#x27;localhost:9090&#x27;]</span><br></pre></td></tr></table></figure>
<p>global：全局配置<br>alerting：设置Prometheus的警报。Prometheus支持Alertmanager服务发现功能。<br>rule_files：指定包含记录规则或警报规则的文件列表。<br>scrape_configs：指定Prometheus抓取的所有目标。</p>
<h2 id="运行Prometheus"><a href="#运行Prometheus" class="headerlink" title="运行Prometheus"></a>运行Prometheus</h2><ol>
<li>将配置文件prometheus.yml移到合适的位置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">mkdir</span> -p /etc/prometheus</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">cp</span> prometheus.yml /etc/prometheus/</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>运行prometheus应用</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">prometheus --config.file <span class="string">&quot;/etc/prometheus/prometheus.yml&quot;</span></span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>如果发生异常，可以使用promtool来验证配置文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">promtool check config prometheus.yml</span></span><br><span class="line">Checking prometheus.yml</span><br><span class="line">    SUCCESS: 0 rule files found</span><br></pre></td></tr></table></figure>
<h2 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h2><ol>
<li>查看指定指标值</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go_gc_duration_seconds&#123;quantile=&quot;0.5&quot;&#125;  1.6166e-05</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>过滤一些匹配标签</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go_gc_duration_seconds&#123;quantile!=&quot;0.5&quot;&#125;  </span><br></pre></td></tr></table></figure>
<ol start="3">
<li>聚合数据求和</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum(promhttp_metric_handler_requests_total) # 求和</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>PromQL通过子名by，按特定维度聚合</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum(promhttp_metric_handler_requests_total) by (job)</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>转换成速率</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum(rate(promhttp_metric_handler_requests_total[5m])) by (job)</span><br></pre></td></tr></table></figure>
<p>rate()函数计算一定范围内时间序列的每秒平均增长率，适合缓慢变化的计数器（counter）。<br>irate()函数计算指定时间范围内的最近两个数据点来算速率，适合快速变化的计数器（counter）。<br>rate()与irate()函数都必须与计数器一起使用。<br>6. 增加数量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">increase(promhttp_metric_handler_requests_total[1h])</span><br></pre></td></tr></table></figure>
<p>指标1小时内增长的值。</p>
<h2 id="容量规划"><a href="#容量规划" class="headerlink" title="容量规划"></a>容量规划</h2><ol>
<li>内存</li>
</ol>
<p>通过以下查询语句查看样本的收集率。显示最后一分钟添加到数据库的每秒样本率。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rate(prometheus_tsdb_head_samples_appended_total[1m])</span><br></pre></td></tr></table></figure>
<p>查询收集的指标数量，通过以下语句</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum(count by (__name__)(&#123;__name__-\~&quot;\.\+&quot;&#125;))</span><br></pre></td></tr></table></figure>
<p>每个样本大小通常为1到2字节，假设在12小时内每秒收集100000个样本，那么内存使用情况为</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">100000 * 2 bytes * 43200秒 约为 8.64GB内存</span><br></pre></td></tr></table></figure>
<p>约为 8.64GB内存，还需要考虑查询与记录规则方面内存的使用情况。<br>可以通过查看process_resident_memory_bytes指标查看Prometheus进程的内存使用情况。<br>2. 磁盘</p>
<p>默认情况下，指标会在本地数据库中存储15天。具体时间由命令行选项控制。<br>–storage.tsdb.path： 设置数据存储目录，默认为Prometheus的目录中。<br>–storage.tsdb.retention： 设置时间序列保留期，默认为15天。<br><code>建议采用SSD作为时间序列数据库的磁盘</code><br>每秒10万个样本的示例，每个样本磁盘上占用约1~2字节，保留15天数据算，大约需要259GB磁盘。</p>
<h1 id="四、监控主机和容器"><a href="#四、监控主机和容器" class="headerlink" title="四、监控主机和容器"></a>四、监控主机和容器</h1><p>Prometheus通过使用exporter工具来暴露主机和应用程序的指标。常用的exporter列表可在以下网站上查看。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://prometheus.io/docs/instrumenting/exporters/</span><br></pre></td></tr></table></figure>
<h2 id="监控主机"><a href="#监控主机" class="headerlink" title="监控主机"></a>监控主机</h2><p>Node Exporter 是用GO语言编写的，收集各种主机指标数据（CPU&#x2F;内存&#x2F;磁盘等）。同时还有一个textfile收集器，允许导出静态指标。</p>
<ol>
<li>安装Node Exporter<br>Node Exporter的下载地址如下：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/prometheus/node_exporter</span><br></pre></td></tr></table></figure>
<p>下载并解压安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget https://github.com/prometheus/node_exporter/releases/download/v0.18.1/node_exporter-0.18.1.linux-amd64.tar.gz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tar -xzf node_exporter-*</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">cp</span> node_exporter-*/node_exporter /user/local/bin/</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>配置Node Exporter<br>node_exporter是通过执行命令时传入参数来配置。</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">node_exporter --<span class="built_in">help</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>默认情况下node_exporter在端口9100上运行，路径为&#x2F;metrics。可通过–web.listen-address和–web.telemetry-path来设置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">node_exporter --web.listen-address=<span class="string">&quot;:9600&quot;</span> --web.telemetry-path=<span class="string">&quot;/node_metrics&quot;</span></span></span><br></pre></td></tr></table></figure>
<p>同时可以通过参数控制启动的收集器，默认的收集器可在以下地址中查看</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/prometheus/node_exporter#enabled-by-default</span><br></pre></td></tr></table></figure>
<p>例如，想要禁用&#x2F;proc&#x2F;net&#x2F;arp统计信息，只需要启动node_exporter时添加<code>--no-collector.arp</code>配置项。<br>3. 配置textfile收集器<br>textfile收集器可以帮助我们暴露自定义指标。node_exporter通过参数<code>--collector.textfile.directory</code>参数指定textfile的目录，它会扫描该目录下的所有文件，提取所有格式为Prometheus指标的字符串，然后暴露它们。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> -p /var/lib/node_exporter/textfile_collector</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">echo</span> <span class="string">&#x27;metadata&#123;role=&quot;docker_server&quot;, datacenter=&quot;NJ&quot;&#125; 1&#x27;</span> | sudo <span class="built_in">tee</span> /var/lib/node_exporter/textfile_collector/metadata.prom</span></span><br></pre></td></tr></table></figure>
<ol start="4">
<li>启用systemd收集器<br>systemd收集器记录systemd中的服务和系统状态。首先需要通过参数<code>--collector.systemd</code>启用该收集器，同时如果不希望收集所有的服务，只收集部分关键服务。node_exporter在启动时可以使用<code>--collector.systemd.unit-whitelist</code>参数配置。</li>
<li>运行Node Exporter<br>启动node_exporter的实例</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">node_exporter --collector.textfile.director /var/lib/node_exporter/textfile_collector --collector.systemd --collector.systemd.unit-whitelist-&#123;(docker|ssh|rsyslog).service<span class="string">&quot;</span></span></span><br></pre></td></tr></table></figure>
<ol start="6">
<li>抓取Node Exporter<br>配置新作业来抓取Node Exporter导出的数据。prometheus.yml文件中的scrape_configs部分添加job</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &#x27;prometheus&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;localhost:9090&#x27;]</span><br><span class="line">  - job_name: &#x27;node&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;192.168.0.3:9100&#x27;, &#x27;192.168.0.4:9100&#x27;, &#x27;192.168.0.5:9100&#x27;]</span><br></pre></td></tr></table></figure>
<p>添加了新的job ‘node’，添加了三台主机的node_exporter监控，默认路径为&#x2F;metrics。<br>重启Prometheus服务，将会加载最新的配置，新监控项将会被收集到prometheus数据中。<br>7. 过滤收集器<br>Prometheus提供了限制抓取过来的数据指标的机制。使用params块中的collect[]来指定收集的指标。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &#x27;node&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;192.168.0.3:9100&#x27;, &#x27;192.168.0.4:9100&#x27;, &#x27;192.168.0.5:9100&#x27;]</span><br><span class="line">    params:</span><br><span class="line">      collect[]:</span><br><span class="line">        - cpu</span><br><span class="line">        - meminfo</span><br><span class="line">        - diskstats</span><br><span class="line">        - netdev</span><br><span class="line">        - netstat</span><br><span class="line">        - filefd</span><br><span class="line">        - filesystem</span><br><span class="line">        - xfs</span><br><span class="line">        - systemd</span><br></pre></td></tr></table></figure>
<p>使用以下命令来模拟测试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -g -X GET http://192.168.0.3:9100/metrics?collect[]=cpu</span></span><br></pre></td></tr></table></figure>
<h2 id="监控Docker容器"><a href="#监控Docker容器" class="headerlink" title="监控Docker容器"></a>监控Docker容器</h2><p>推荐使用Google的cAdvisor工具来监控Docker。cAdvisor作为Docker容器运行，单个cAdvisor容器返回针对Docker守护进程和所有正在运行的容器的指标。</p>
<ol>
<li>运行cAdvisor</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker run \</span></span><br><span class="line"><span class="language-bash">-v /:/rootfs:ro \</span></span><br><span class="line"><span class="language-bash">-v /var/run:/var/run:rw \</span></span><br><span class="line"><span class="language-bash">-v /sys:/sys:ro \</span></span><br><span class="line"><span class="language-bash">-v /var/lib/docker/:/var/lib/docker:ro \</span></span><br><span class="line"><span class="language-bash">-v /dev/disk/:/dev/disk:ro \</span></span><br><span class="line"><span class="language-bash">-p 8080:8080 \</span></span><br><span class="line"><span class="language-bash">-d --name=cadvisor \</span></span><br><span class="line"><span class="language-bash">google/cadvisor:latest</span></span><br></pre></td></tr></table></figure>
<p>通过浏览器访问<a target="_blank" rel="noopener" href="http://192.168.0.3:8080/containers/%E5%8F%AF%E6%9F%A5%E7%9C%8B">http://192.168.0.3:8080/containers/可查看</a><br><img src="https://img.xhua.eu.org/e00420385b6a381e48b2720f6f06a80923a48dca9c1090627348c8cf26eeabb4.jpg" alt="cAdvisor">  </p>
<p>通过浏览器访问<a target="_blank" rel="noopener" href="http://192.168.0.3:8080/metrics%E6%9F%A5%E7%9C%8B%E6%9A%B4%E9%9C%B2%E7%9A%84%E5%86%85%E7%BD%AEPrometheus%E6%8C%87%E6%A0%87">http://192.168.0.3:8080/metrics查看暴露的内置Prometheus指标</a><br><img src="https://img.xhua.eu.org/bf56e152574f3826c60b507be21085d05115bb0e27748ca0dee37258e8f918cf.jpg" alt="cAdvisor指标">  </p>
<ol start="2">
<li>抓取cAdvisor<br>配置新作业来抓取cAdvisor导出的数据。prometheus.yml文件中的scrape_configs部分添加job</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &#x27;prometheus&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;localhost:9090&#x27;]</span><br><span class="line">  - job_name: &#x27;node&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;192.168.0.3:9100&#x27;, &#x27;192.168.0.4:9100&#x27;, &#x27;192.168.0.5:9100&#x27;]</span><br><span class="line">  - job_name: &#x27;docker&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;192.168.0.3:8080&#x27;, &#x27;192.168.0.4:8080&#x27;, &#x27;192.168.0.5:8080&#x27;]</span><br></pre></td></tr></table></figure>
<p>添加了新的job ‘docker’，添加了三台主机的node_exporter监控，默认路径为&#x2F;metrics。</p>
<h2 id="Prometheus抓取数据的生命周期"><a href="#Prometheus抓取数据的生命周期" class="headerlink" title="Prometheus抓取数据的生命周期"></a>Prometheus抓取数据的生命周期</h2><p><img src="https://img.xhua.eu.org/09de44fe6e1aa13aaaed501e8fbd1b6b8ebeac3059fc73c65a46c5a1218ea602.jpg" alt="Prometheus抓取数据的生命周期简化版">  </p>
<p>可以看到在Prometheus抓取数据的生命周期中，有两处重新标记指标的部分，一个在抓取前，一个是在抓取后。</p>
<h2 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h2><p>标签提供了时间序列的维度，可以定义目标，并为时间序列提供上下文。最重要的是，结合指标名称，它们构成了时间序列的标识。<br>更改或者添加标签会创建新的时间序列</p>
<ol>
<li><p>标签分类：拓扑标签、模式标签<br>拓扑标签：通过其物理或者逻辑组成来切割服务组件。每个指标都天然带着job和instance两个拓扑标签。instance标签可以标识目标，通常是目标的IP地址和端口，并且来自__address__标签。<br>模式标签：url、error_code或者user之类，允许将拓扑中同一级别的时间序列匹配在一起。<br>如果需要添加额外的标签，可以考虑以下的层次结构<br><img src="https://img.xhua.eu.org/fcbef27c720f8c1f18917b04ea0fe1f426d8ddca1b2ffae9be3ecd3292d78acc.jpg" alt="标签层次结构参考">  </p>
</li>
<li><p>重新标记<br>控制标签。有两个阶段可以重新标记标签。抓取前的relabel_configs和抓取后的metric_relabel_configs模式。</p>
</li>
</ol>
<ul>
<li>删除不必要的指标</li>
<li>从指标中删除敏感或不需要的标签</li>
<li>添加、编辑、修改指标的标签值或标签格式</li>
</ul>
<blockquote>
<p>在拉取了cAdvisor的指标数据后，删除<code>container_tasks_state</code>与<code>container_memory_failures_total</code>指标数据</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &#x27;docker&#x27;</span><br><span class="line">   static_configs:</span><br><span class="line">     - targets: [&#x27;192.168.0.3:8080&#x27;, &#x27;192.168.0.4:8080&#x27;, &#x27;192.168.0.5:8080&#x27;]</span><br><span class="line">   metric_relabel_configs:</span><br><span class="line">     - source_labels: [__name__]</span><br><span class="line">       separator: &#x27;;&#x27;</span><br><span class="line">       regex: &#x27;(container_tasks_state|container_memory_failures_total)&#x27;</span><br><span class="line">       action: drop</span><br></pre></td></tr></table></figure>
<p>separator默认值为’;’，多个标签通过separator连接在一起。<br>如果指定多个源标签，可以使用；隔开每个正则表达式。<br>action: drop将会在数据存储之前删除指标，keep则会保留与正则匹配的指标，删除所有其他指标。</p>
<blockquote>
<p>正则配置id指标中的数据，并将匹配的值放入新的标签container_id中。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &#x27;docker&#x27;</span><br><span class="line">   static_configs:</span><br><span class="line">     - targets: [&#x27;192.168.0.3:8080&#x27;, &#x27;192.168.0.4:8080&#x27;, &#x27;192.168.0.5:8080&#x27;]</span><br><span class="line">   metric_relabel_configs:</span><br><span class="line">     - source_labels: [id]</span><br><span class="line">       regex: &#x27;/docker/([a-z0-9]+);&#x27;</span><br><span class="line">       replacement: &#x27;$1&#x27;</span><br><span class="line">       target_label: container_id</span><br></pre></td></tr></table></figure>
<p>没有指定action操作，因为metric_relabel_configs的action默认操作为replace。<br>honor_labels默认值为false，如果target_label的标签已经存在，则会在其前面添加exported_前缀来做区分。</p>
<blockquote>
<p>删除标签kernelVersion</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &#x27;docker&#x27;</span><br><span class="line">   static_configs:</span><br><span class="line">     - targets: [&#x27;192.168.0.3:8080&#x27;, &#x27;192.168.0.4:8080&#x27;, &#x27;192.168.0.5:8080&#x27;]</span><br><span class="line">   metric_relabel_configs:</span><br><span class="line">     - regex: &#x27;kernelVersion&#x27;</span><br><span class="line">       action: labeldrop</span><br></pre></td></tr></table></figure>
<p>action: labeldrop，删除匹配的标签<br>action: labelkeep，保留匹配的标签，删除所有其他标签</p>
<h2 id="Node-Exporter和cAdvisor指标"><a href="#Node-Exporter和cAdvisor指标" class="headerlink" title="Node Exporter和cAdvisor指标"></a>Node Exporter和cAdvisor指标</h2><ol>
<li>CPU使用率</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">100 - avg(irate(node_cpu_seconds_total&#123;job=&quot;node&quot;, mode=&quot;idle&quot;&#125;[5m])) by (instance) * 100</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>CPU饱和度</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_load1 &gt; on (instance) 2 * count by (instance)(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;)</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>内存使用率</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(node_memory_MemTotal_bytes - (node_memory_MemFree_bytes + node_memory_Cached_bytes + node_memory_Buffers_bytes)) / node_memory_MemTotal_bytes * 100</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>内存饱和度</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1024 * sum by (instance) ((rate(node_vmstat_pgpgin[1m]) + rate(node_vmstat_pgpgout[1m])))</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>磁盘使用率</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(node_fileystem_size_bytes&#123;mountpoint=~&quot;/|/run&quot;&#125; - node_filesystem_free_bytes&#123;mountpoint=~&quot;/|/run&quot;&#125;) / node_filesystem_size_bytes&#123;mountpoint=~&quot;/|/run&quot;&#125; * 100</span><br></pre></td></tr></table></figure>
<p>Prometheus支持预测</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">predict_linear(node_fileystem_size_bytes&#123;job=&quot;node&quot;&#125;[1h], 4*3600) &lt; 0</span><br></pre></td></tr></table></figure>
<p>使用1个小时窗口数据，预测所有磁盘4个小时后的磁盘会不会用完。<br>6. 服务状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_systemd_unit_state&#123;name=&quot;docker.service&quot;, state=&quot;active&quot;&#125;</span><br></pre></td></tr></table></figure>
<ol start="7">
<li>exporter的可用性和up指标</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">up &#123;job=&quot;node&quot;, instance=&quot;192.168.0.3:9100&quot;&#125;</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>textfile收集器metadata指标</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">metadata&#123;datacenter != &quot;NJ&quot;&#125;</span><br><span class="line">node_systemd_unit_state&#123;name=&quot;docker.service&quot;&#125; == 1 and on (instance, job) metadata&#123;datacenter = &quot;SF&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>on：一对一匹配<br>group_left：多对一<br>group_right：一对多<br>详情：<a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/latest/querying/operators/#vector-matching">https://prometheus.io/docs/prometheus/latest/querying/operators/#vector-matching</a></p>
<h2 id="查询持久化"><a href="#查询持久化" class="headerlink" title="查询持久化"></a>查询持久化</h2><p>三种方式使查询持久化</p>
<ul>
<li>记录规则：根据查询创建新指标</li>
<li>警报规则：从查询生成警报</li>
<li>可视化：使用Grafana等仪表板可视化查询</li>
</ul>
<p>记录规则<br>prometheus.yml中的配置项<code>evaluation_interval</code>设置为自动计算记录的规则。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  scrape_interval: 15s</span><br><span class="line">  evaluation_interval: 15s</span><br></pre></td></tr></table></figure>
<p>在prometheus.yml文件的同一文件夹下，创建名为rules的子文件夹，用于保存记录规则。同时在prometheus.yml配置文件中的rule_files块中添加文件<code>rules/node_rules.yml</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> -p rules &amp;&amp; <span class="built_in">cd</span> rules</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> &gt; node_rules.yml &lt;&lt;<span class="string">EOF</span></span></span><br><span class="line">groups:</span><br><span class="line">- name: node_rules</span><br><span class="line">  interval: 10s</span><br><span class="line">  rules:</span><br><span class="line">  - record: instance:node_cpu:avg_rate5m</span><br><span class="line">    expr: 100 - avg(irate(node_cpu_seconds_total&#123;job=&quot;node&quot;, mode=&quot;idle&quot;&#125;[5m])) by (instance) * 100</span><br><span class="line">    labels:</span><br><span class="line">      metric_type: aggregation</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>创建了名为”node_rules”的规则组，顺序执行规则，后面的规则可以重用前面的规则。规则组间是并行运行的，因此不建议跨组使用规则。<br>interval：10s 可以设置interval覆盖默认的evaluation_interval值。<br>record：<strong>应该仔细为新的时间序列取名，以便快速识别它的含义，一般推荐的格式是：</strong> <code>level:metric:operations</code><br>expr：保存生成新时间序列的查询<br>labels：向新序列添加新的标签</p>
<h2 id="可视化-Grafana"><a href="#可视化-Grafana" class="headerlink" title="可视化 Grafana"></a>可视化 Grafana</h2><ol>
<li>安装Grafana</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget https://dl.grafana.com/oss/release/grafana-6.5.1-1.x86_64.rpm</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo yum localinstall grafana-6.5.1-1.x86_64.rpm</span></span><br></pre></td></tr></table></figure>
<p>使用ansible role安装：<a target="_blank" rel="noopener" href="https://galaxy.ansible.com/list#roles/3563">https://galaxy.ansible.com/list#roles/3563</a><br>使用Docker镜像安装：<a target="_blank" rel="noopener" href="https://hub.docker.com/search/?q=grafana">https://hub.docker.com/search/?q=grafana</a><br>2. 启动与配置Grafana<br>配置文件位于<code>/etc/grafana/grafana.ini</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">systemctl start grafana-server</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>浏览器访问<a href="http://localhost:3000，默认用户名和密码为admin和admin。">http://localhost:3000，默认用户名和密码为admin和admin。</a><br>Grafana仪表盘实例查看地址：<a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards">https://grafana.com/grafana/dashboards</a><br><img src="https://img.xhua.eu.org/2076ee0e76cebf306876738067177ef0c906b2b4c259a19a1eab6509008e7607.jpg" alt="Grafana"></li>
</ol>
<h1 id="五、Prometheus服务发现"><a href="#五、Prometheus服务发现" class="headerlink" title="五、Prometheus服务发现"></a>五、Prometheus服务发现</h1><p>对于主机数少的情况下，Prometheus可以使用静态配置目标。当规模较大的集群时，就不适用了。服务发现可以通过以下三种机制实现：</p>
<ul>
<li>配置管理工具生成的文件中接收目标列表</li>
<li>查询API以获取目标列表</li>
<li>使用DNS记录以返回目标列表</li>
</ul>
<h2 id="基于文件的服务发现"><a href="#基于文件的服务发现" class="headerlink" title="基于文件的服务发现"></a>基于文件的服务发现</h2><p>适合配置管理工具。Prometheus会按指定时间计划从这些文件重新加载目标，文件格式支持yaml、Json格式，它们包含了目标列表。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- job_name: node</span><br><span class="line">  file_sd_configs:</span><br><span class="line">    - files:</span><br><span class="line">      - targets/nodes/*.json</span><br><span class="line">        refresh_interval: 5m</span><br><span class="line">- job_name: docker</span><br><span class="line">  file_sd_configs:</span><br><span class="line">    - files:</span><br><span class="line">      - targets/docker/*.yml</span><br><span class="line">        refresh_interval: 5m</span><br></pre></td></tr></table></figure>
<p>新建nodes与docker目录，并添加对应的配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> /etc/prometheus</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> -p targets/&#123;nodes,docker&#125;</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> &gt; targets/nodes/nodes.json &lt;&lt;<span class="string">EOF</span></span></span><br><span class="line">[&#123;</span><br><span class="line">  &quot;targets&quot;: [</span><br><span class="line">    &#x27;192.168.0.3:9100&#x27;, </span><br><span class="line">    &#x27;192.168.0.4:9100&#x27;, </span><br><span class="line">    &#x27;192.168.0.5:9100&#x27;</span><br><span class="line">  ]</span><br><span class="line">&#125;]</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="string">cat &gt; targets/docker/daemons.yml &lt;&lt;EOF</span></span></span><br><span class="line">- targets:</span><br><span class="line">  - &#x27;192.168.0.3:8080&#x27;</span><br><span class="line">  - &#x27;192.168.0.4:8080&#x27;</span><br><span class="line">  - &#x27;192.168.0.5:8080&#x27;</span><br><span class="line">  labels:</span><br><span class="line">    datacenter: NJ</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h2 id="基于API的服务发现"><a href="#基于API的服务发现" class="headerlink" title="基于API的服务发现"></a>基于API的服务发现</h2><p>当前API的服务发现支持以下平台：</p>
<ul>
<li>AWS EC2</li>
<li>Azure</li>
<li>Consul</li>
<li>Google Compute Cloud</li>
<li><a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config">Kubernetes</a></li>
</ul>
<h2 id="基于DNS的服务发现"><a href="#基于DNS的服务发现" class="headerlink" title="基于DNS的服务发现"></a>基于DNS的服务发现</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- job_name: webapp</span><br><span class="line">  dns_sd_configs:</span><br><span class="line">    - names: [&#x27;_prometheus._tcp.example.com&#x27;]</span><br></pre></td></tr></table></figure>
<p>Prometheus在查询目标时，通过DNS服务器查找example.com域，然后在该域下搜索名为_prometheus._tcp.example.com的SRV记录，返回该条目中的服务记录。<br>还可以使用DNS服务发现来查询单个A或AAAA记录。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- job_name: webapp</span><br><span class="line">  dns_sd_configs:</span><br><span class="line">    - names: [&#x27;example.com&#x27;]</span><br><span class="line">      type: A</span><br><span class="line">      port: 9100</span><br></pre></td></tr></table></figure>
<p>返回example.com域根目录下的所有A记录。</p>
<h1 id="六、Alert-Manager报警管理"><a href="#六、Alert-Manager报警管理" class="headerlink" title="六、Alert Manager报警管理"></a>六、Alert Manager报警管理</h1><p>监控是为了了解系统的状态，以便于及时发现问题。当指标出现异常时，我们应该第一时间知道，便及时处理，但是我们又无法实时关注在每个监控指标，这时我们就需要告警机制。没有告警机制的监控，像是摆在家里的花瓶，它很美但用处不大。<br><strong>一个好的警报应该是，在正确的时间、发给正确的人、恰当的量、包含准确（不多也不少）的信息。</strong></p>
<ul>
<li>适当数量的警报</li>
<li>设置正确的警报优先级</li>
<li>警报应包括适当的上下文</li>
</ul>
<h2 id="Alertmanager如何工作"><a href="#Alertmanager如何工作" class="headerlink" title="Alertmanager如何工作"></a>Alertmanager如何工作</h2><p>Prometheus服务器向Alertmanager发送警报，当然Alertmanager也可以接收其他工具的警报。Alertmanager对警报进行去重、分组，然后路由到不同的接收器：email，sms等。</p>
<ul>
<li>在Prometheus服务上编写警报规则</li>
<li>当指标达到阈值时，会生成警报推送到Alertmanager。</li>
<li>一个或多个Prometheus服务器可以将警报定向到单个Alertmanager下</li>
<li>Alertmanager处理警报，并根据其标签进行路由。</li>
</ul>
<h2 id="Alertmanager安装、配置、运行"><a href="#Alertmanager安装、配置、运行" class="headerlink" title="Alertmanager安装、配置、运行"></a>Alertmanager安装、配置、运行</h2><ol>
<li>Alertmanager安装</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget https://github.com/prometheus/alertmanager/releases/download/v0.20.0-rc.0/alertmanager-0.20.0-rc.0.linux-amd64.tar.gz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tar -xzf alertmanager-0.20.0-rc.0.linux-amd64.tar.gz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">cp</span> alertmanager-0.20.0-rc.0.linux-amd64/alertmanager /usr/local/bin/</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">cp</span> alertmanager-0.20.0-rc.0.linux-amd64/amtool /usr/local/bin/</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>配置Alertmanager<br><a target="_blank" rel="noopener" href="https://prometheus.io/docs/alerting/configuration/">https://prometheus.io/docs/alerting/configuration/</a></li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">mkdir</span> -p /etc/alertmanager</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">cat</span> &gt; /etc/alertmanager/alertmanager.yml &lt;&lt;<span class="string">EOF</span></span></span><br><span class="line">global:</span><br><span class="line">  smtp_smarthost: &#x27;localhost:25&#x27;</span><br><span class="line">  smtp_from: &#x27;alertmanager@example.com&#x27;</span><br><span class="line">  smtp_require_tls: false</span><br><span class="line"></span><br><span class="line">templates:</span><br><span class="line">- &#x27;/etc/alertmanager/template/*.tmpl&#x27;</span><br><span class="line"></span><br><span class="line">route:</span><br><span class="line">  receiver: email</span><br><span class="line"></span><br><span class="line">receivers:</span><br><span class="line">- name: &#x27;email&#x27;</span><br><span class="line">  email_configs:</span><br><span class="line">  - to: &#x27;alerts@example.com&#x27;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>global：全局设置，为其他模块的默认值<br>template：保存警报模板<br>route：警报根据规则进行匹配，采取相应的操作<br>receivers：接收器列表，每个接收器有唯一的名字及配置。<a target="_blank" rel="noopener" href="https://prometheus.io/docs/alerting/configuration/#email_config">email_configs</a>来指定电子邮件选项，<a target="_blank" rel="noopener" href="https://prometheus.io/docs/alerting/configuration/#webhook_config">webhook_configs</a>可以扩展Alertmanager的接收器。<br>3. 运行Alertmanager</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">alertmanager --config.file alertmanager.yml</span></span><br></pre></td></tr></table></figure>
<p>通过浏览器访问alertmanager，<a target="_blank" rel="noopener" href="http://localhost:9093/">http://localhost:9093</a></p>
<h2 id="Prometheus配置Alertmanager"><a href="#Prometheus配置Alertmanager" class="headerlink" title="Prometheus配置Alertmanager"></a>Prometheus配置Alertmanager</h2><ol>
<li>在prometheus.yml配置中设置alerting模块。</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    -targets:</span><br><span class="line">      - alertmanager:9093</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>监控Alertmanager<br>Alertmanager服务暴露了自身的相关指标，创建一个Prometheus Job就可以监控Alertmanager</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &#x27;alertmanager&#x27;</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets: [&#x27;localhost:9093&#x27;]</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>添加警报规则<br>与记录规则一样，警报规则在Prometheus服务器配置中加载的规则文件内也使用Yaml语句定义。<br>在prometheus.yml配置文件中的rule_files块中添加文件rules&#x2F;node_alerts.yml<br>在rules目录下创建文件node_alerts.yml来保存节点报警规则。</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> &gt; rules/node_alerts.yml &lt;&lt;<span class="string">EOF</span></span></span><br><span class="line">groups:</span><br><span class="line">- name: node_alerts</span><br><span class="line">  rules:</span><br><span class="line">  - alert: HighNodeCPU</span><br><span class="line">    expr: instance:node_cpu:avg_rate5m &gt; 80</span><br><span class="line">    for: 60m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: High Node CPU for 1 hour</span><br><span class="line">      console: You might want to check the Node Dashboard at http://grafana.example.com/dashboard/db/node-dashboard</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>alert：规则名<br>expr：触发规则<br>for：控制在触发警报之前测试表达式必须为true的时长<br>labels与annotations：装饰警报</p>
<p>警报有三种状态：<br>Inactive：警报未激活<br>Pending：警报已满足测试表达式条件，但仍在等待for子句中指定的持续时长<br>Firing：警报（如果没有设置for，则一旦触发条件，立刻Firing）</p>
<p>Pending、Firing状态下的警报可以在Prometheus的指标中查看到ALERTS。<br>新的警报与模板示例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">groups:</span><br><span class="line">- name: node_alerts</span><br><span class="line">  rules:</span><br><span class="line">  - alert: DiskWillFillIn4Hours</span><br><span class="line">    expr: predict_linear(node_fileystem_size_bytes&#123;mountpoing=&quot;/&quot;&#125;[1h], 4*3600) &lt; 0</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: Disk on &#123;&#123; $labels.instance &#125;&#125; will fill in approximately 4 hours.</span><br><span class="line">  - alert: InstanceDown</span><br><span class="line">    expr: up&#123;job=&quot;node&quot;&#125; == 0</span><br><span class="line">    for: 10m</span><br><span class="line">    labels:</span><br><span class="line">      severity: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: Host &#123;&#123; $labels.instance &#125;&#125; of &#123;&#123; $labels.job &#125;&#125; is down!</span><br><span class="line">  - alert: NodeServiceDown</span><br><span class="line">    expr: node_systemd_unit_state&#123;state=&quot;active&quot;&#125; != 1</span><br><span class="line">    for: 60s</span><br><span class="line">    labels:</span><br><span class="line">      severity: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: Service &#123;&#123;$labels.name&#125;&#125; on &#123;&#123; $labels.instance &#125;&#125; is no longer active!</span><br><span class="line">      description: Service Down</span><br><span class="line">  - alert: InstanceGone</span><br><span class="line">    expr: absent(up&#123;job=&quot;node&quot;&#125;)</span><br><span class="line">    for: 10s</span><br><span class="line">    labels:</span><br><span class="line">      severity: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: Host &#123;&#123; $labels.instance &#125;&#125; is no logger reporting!</span><br><span class="line">      description: &#x27;OMG Where are my instances&#x27;</span><br><span class="line">- name: prometheus_alerts</span><br><span class="line">  rules:</span><br><span class="line">  - alert: PrometheusConfigReloadFailed</span><br><span class="line">    expr: prometheus_config_last_reload_successful == 0</span><br><span class="line">    for: 10m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      description: Reloading Prometheus configuration has failed on &#123;&#123; $lables.instance &#125;&#125;.</span><br><span class="line">  - alert: PrometheusNotConnectedToAlertmanagers</span><br><span class="line">    expr: prometheus_notifications_alertmanagers_discovered &lt; 1</span><br><span class="line">    for: 10m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      description: Prometheus &#123;&#123; $labels.instance &#125;&#125; is not connected to any Alertmanagers.</span><br></pre></td></tr></table></figure>
<h2 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h2><p>Alertmanager的配置文件alertmanager.yml中添加一些路由配置。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">route:</span><br><span class="line">  group_by: [&#x27;instance&#x27;]</span><br><span class="line">  group_wait: 30s</span><br><span class="line">  group_interval: 5m</span><br><span class="line">  repeat_interval: 3h</span><br><span class="line">  receiver: email</span><br><span class="line">  routes:</span><br><span class="line">  - match:</span><br><span class="line">      severity: critical</span><br><span class="line">    receiver: pager</span><br><span class="line">  - match_re:</span><br><span class="line">      severity: ^(warning|critical)$</span><br><span class="line">    receiver: support_team</span><br><span class="line"></span><br><span class="line">receivers:</span><br><span class="line">- name: &#x27;email&#x27;</span><br><span class="line">  email_configs:</span><br><span class="line">  - to: &#x27;alert@example.com&#x27;</span><br><span class="line">    send_resolved: true</span><br><span class="line">- name: &#x27;support_team&#x27;</span><br><span class="line">  email_configs:</span><br><span class="line">  - to: &#x27;support@example.com&#x27;</span><br><span class="line">- name: &#x27;pager&#x27;</span><br><span class="line">  email_configs:</span><br><span class="line">  - to: &#x27;alert-pager@example.com&#x27;</span><br><span class="line">  pagerduty_configs:</span><br><span class="line">  - service_key: TEAFDSFEWS</span><br></pre></td></tr></table></figure>
<p>group_by：对Alertmanager警报指定分组方式，如按照instance来分组<br>group_wait：如果进行分组，Alertmanager会等待group_wait指定的时间，以便在触发报警前查看是否收到该组中的其他报警<br>group_interval：如果发出警报后，Alertmanager收到该分组的下一次评估的新警报后，会等待group_interval时间后再发送新警报，以免警报泛滥<br>repeat_interval：适用于单个警报，等待重新发送相同警报的时间段<br>receiver：默认接收器<br>send_resolved: 恢复后发送通知<br>routes：路由规则。如果需要routers还可以分支。如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">routes:</span><br><span class="line">- match:</span><br><span class="line">    severity: critical</span><br><span class="line">  receiver: pager</span><br><span class="line">  routes:</span><br><span class="line">  - match:</span><br><span class="line">      service: application1</span><br><span class="line">    receiver: support_team</span><br></pre></td></tr></table></figure>
<h2 id="通知模板"><a href="#通知模板" class="headerlink" title="通知模板"></a>通知模板</h2><p>模板目录：&#x2F;etc&#x2F;alertmanager&#x2F;templates</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> &gt; /etc/alertmanager/templates/slack.tmpl &lt;&lt;<span class="string">EOF</span></span></span><br><span class="line">&#123;&#123; define &quot;annotation.summary.text&quot; &#125;&#125;&#123;&#123; .CommonAnnotations.summary&#125;&#125;&#123;&#123;end&#125;&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>对应的slack_configs receiver配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  slack_configs:</span><br><span class="line">  - api_url: https://hooks.slack.com/services/ABC123/fsdaf、</span><br><span class="line">EXAMPLE</span><br><span class="line">  channel: #monitoring</span><br><span class="line">  text: &#x27;&#123;&#123;template &quot;annotation.summary.text&quot; .&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>使用模板通知来填充text字段，使用上下文通知。</p>
<h2 id="silence和维护"><a href="#silence和维护" class="headerlink" title="silence和维护"></a>silence和维护</h2><p>报警静默设置。当服务进行维护时，不需要发出告警，使用silence进行控制。两种方法进行设置：</p>
<ul>
<li>通过Alertmanger Web控制台</li>
<li>通过amtool命令工具</li>
</ul>
<ol>
<li>使用amtool添加silence。默认为1h过期时间，可以指定–expires和–expire-on参数指定更长的时间与窗口</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">amtool --alertmanager.url=http://localhost:9093 silence add alertname=InstancesGone service=application1</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>使用query命令查询silence列表</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">amtool  --alertmanager.url=http://localhost:9093 silence query</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>指定silence过期</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">amtool  --alertmanager.url=http://localhost:9093 silence expire <span class="variable">$SILENCE_ID</span></span></span><br></pre></td></tr></table></figure>
<ol start="4">
<li>使用正则创建silence</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">amtool  --alertmanager.url=http://localhost:9093 silence add --comment <span class="string">&quot;App1 maintenance&quot;</span> alertname=~<span class="string">&#x27;Instance.*&#x27;</span> service=application1</span></span><br></pre></td></tr></table></figure>
<h1 id="七、Prometheus高可用性"><a href="#七、Prometheus高可用性" class="headerlink" title="七、Prometheus高可用性"></a>七、Prometheus高可用性</h1><p>Prometheus通过运行两个配置相同的Prometheus服务器，并且它们同时处于活动状态来实现容错。该配置生成的重复警报交由上游Alertmanager使用其分组功能进行处理。所以一个推荐的做法是关注Alertmanager的高可用，而不是Prometheus服务。<br>通过创建一个Alertmanager集群来实现高可用，所有Prometheus服务器将告警发送到Alertmamanager集群，而Alertmanager负责去除重复数据。</p>
<h2 id="设置Alertmanager集群"><a href="#设置Alertmanager集群" class="headerlink" title="设置Alertmanager集群"></a>设置Alertmanager集群</h2><p>Alertmanager包含由HashiCorp Memberlist库提供的集群功能。</p>
<ol>
<li>在多台主机上安装Alertmanager</li>
<li>启动Alertmanager，传入参数–cluster.listen-address<br>第一台主机启动Alertmanager命令如下：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">alertmanager --config.file alertmanager.yml --cluster.listen-address 192.168.0.3:8001</span></span><br></pre></td></tr></table></figure>
<p>剩下的主机启动Alertmanager命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">alertmanager --config.file alertmanager.yml --cluster.listen-address 192.168.0.4:8001 --cluster.peer 192.168.0.3:8001</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>在Alertmanager的控制台状态页面&#x2F;status上查看集群状态</li>
<li>为Prometheus配置Alertmanager集群</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">    - static_configs:</span><br><span class="line">      - targets:</span><br><span class="line">        - 192.168.0.3:9093</span><br><span class="line">        - 192.168.0.4:9093</span><br><span class="line">        - 192.168.0.5:9093</span><br></pre></td></tr></table></figure>
<p>三个Alertmanager服务都会收到告警信息，保证告警可达。</p>
<h2 id="可扩展性"><a href="#可扩展性" class="headerlink" title="可扩展性"></a>可扩展性</h2><p><a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/latest/federation/">Prometheus federation API</a>抓取每个工作节点的聚合指标<br>一个很好的例子是：基于区域的主节点和工作节点，基于区域的主节点视为全局的工作节点，然后向全局的主节点进行报告。<br>因为是金字塔级结构，主节点可能会有延时，所以尽量通过工作节点向Alertmanager发送告警。<br><strong>水平分片通常是最后的选择。每个目标都有数万个指标或者大量时间序列。</strong></p>
<p>Prometheus work0配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  external_labels:</span><br><span class="line">    worker: 0</span><br><span class="line">rule_files:</span><br><span class="line">  - &quot;rules/node_rules.yml&quot;</span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &#x27;node&#x27;</span><br><span class="line">    file_sd_configs:</span><br><span class="line">    - files:</span><br><span class="line">      - targets/nodes/*.json</span><br><span class="line">        refresh_interval: 5m</span><br><span class="line">    relabel_configs:</span><br><span class="line">    - source_labels: [__address__]</span><br><span class="line">      modulus: 3</span><br><span class="line">      target_label: __tmp_hash</span><br><span class="line">      action: hashmod</span><br><span class="line">    - source_labels: [__tmp_hash]</span><br><span class="line">      regex: ^0$</span><br><span class="line">      action: keep</span><br></pre></td></tr></table></figure>
<p>该过程是使用hashmod模块对<code>__address__</code>标签的值对3取Mod，如果余数为0，则保留。<br>同样的方法配置好work1与work2节点。</p>
<p>Prometheus 主节点配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">scrap_configs:</span><br><span class="line">- job_name: &#x27;node_workers&#x27;</span><br><span class="line">  file_sd_configs:</span><br><span class="line">    - files:</span><br><span class="line">      - &#x27;targets/workers.json&#x27;</span><br><span class="line">      refresh_interval: 5m</span><br><span class="line">  honor_labels: true</span><br><span class="line">  metrics_path: /federate</span><br><span class="line">  params:</span><br><span class="line">    &#x27;match[]&#x27;:</span><br><span class="line">      - &#x27;&#123;__name__=&quot;^instance:.*&quot;&#125;&#x27;</span><br></pre></td></tr></table></figure>
<p>其中targets&#x2F;workers.json内容为</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[&#123;</span><br><span class="line">  &quot;targets&quot;: [</span><br><span class="line">    &quot;worker0:9090&quot;,</span><br><span class="line">    &quot;worker1:9090&quot;,</span><br><span class="line">    &quot;worker2:9090&quot;,</span><br><span class="line">  ]</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>
<p>Prometheus支持使用&#x2F;federate API根据指定的匹配参数来查询服务器指标。</p>
<h1 id="八、日志监控"><a href="#八、日志监控" class="headerlink" title="八、日志监控"></a>八、日志监控</h1><p>使用<a target="_blank" rel="noopener" href="https://github.com/google/mtail">mtail</a>作为日志处理工具，它是Google开发的，非常轻巧。它专门用于从应用程序日志中提取要导出到时间序列数据库中的指标。</p>
<ol>
<li>安装mtail</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget https://github.com/google/mtail/releases/download/v3.0.0-rc33/mtail_v3.0.0-rc33_linux_amd64 -O mtail</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">chmod</span> 0755 mtail</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">cp</span> mtail /usr/local/bin/</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>使用mtail<br>mtail通过命令进行配置，指定日志文件列表，以及运行的程序目录。每个mtail程序都以.mtail为后缀名。</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">mkdir</span> /etc/mtail</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> &gt; /etc/mtail/line_count.mtail &lt;&lt;<span class="string">EOF</span></span></span><br><span class="line">counter line_count</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">/$</span><span class="language-bash"><span class="string">/ &#123;</span></span></span><br><span class="line">  line_count++</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>程序定义了一个名为line_count的计数器（计数器 counter，测量型 gauge）。这些计数与测量通过mtail导出到定义的任何目的地。<br>3. 运行mtail</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo mtail --progs /etc/mtail --logs <span class="string">&#x27;/var/log/*.log&#x27;</span></span> </span><br></pre></td></tr></table></figure>
<p>–progs：指定mtail程序所在目录<br>–logs：指定日志文件<br>执行后，mtail将在3903端口上启动Web服务（使用–address和–port参数设置IP与端口）。<a target="_blank" rel="noopener" href="http://localhost:3903/metrics%E8%B7%AF%E5%BE%84%E5%8F%AF%E4%BB%A5%E8%A2%ABPrometheus%E8%8E%B7%E5%8F%96%E7%9B%B8%E5%85%B3%E7%9B%91%E6%8E%A7%E6%95%B0%E6%8D%AE%E3%80%82">http://localhost:3903/metrics路径可以被Prometheus获取相关监控数据。</a></p>
<h2 id="处理Web服务器访问日志"><a href="#处理Web服务器访问日志" class="headerlink" title="处理Web服务器访问日志"></a>处理Web服务器访问日志</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">LogFormat <span class="string">&quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer|i\&quot; \&quot;%&#125;User-agent|i\&quot;</span></span></span><br><span class="line">counter apache_http_requests_total by request_method, http_version, request_status</span><br><span class="line">counter apache_http_bytes_total by request_method, http_version, request_status</span><br><span class="line"></span><br><span class="line">/^/ +</span><br><span class="line">/(?P&lt;hostname&gt;[0-9A-Za=z\.-]+) / + # %h</span><br><span class="line">/(?P&lt;remote_logname&gt;[0-9A-Za=z\.-]+) / + # %l</span><br><span class="line">/(?P&lt;remote_username&gt;[0-9A-Za=z\.-]+) / + # %u</span><br><span class="line">/(?P&lt;timestamp&gt;\[\d&#123;2&#125;\/\w&#123;3&#125;\/\d&#123;4&#125;:\d&#123;2&#125;:\d&#123;2&#125;:\d&#123;2&#125; (\+|-)\d&#123;4&#125;\]) / + # %u</span><br><span class="line">/&quot;(?P&lt;request_method&gt;[A-Z]+) (?P&lt;URI&gt;\S+) (?P&lt;http_version&gt;HTTP\/[0-9\.]+)&quot; / + # \&quot;%r\&quot;</span><br><span class="line">/(?P&lt;request_status&gt;\d&#123;3&#125;) / + # %&gt;s</span><br><span class="line">/(?P&lt;response_size&gt;\d+) / + # %b</span><br><span class="line">/&quot;(?P&lt;referer&gt;\S+)&quot; / + # \&quot;%&#123;Referer&#125;i\&quot;</span><br><span class="line">/&quot;(?P&lt;user_agent&gt;[[:print:]]+)&quot;/ + # \&quot;%&#123;User-agent&#125;i\&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">/$</span><span class="language-bash"><span class="string">/ &#123;</span></span></span><br><span class="line"><span class="meta prompt_">  apache_http_requests_total[$</span><span class="language-bash"><span class="string">request_method][<span class="variable">$http_version</span>][<span class="variable">$request_status</span>]++</span></span></span><br><span class="line"><span class="meta prompt_">  apache_http_bytes_total[$</span><span class="language-bash"><span class="string">request_method][<span class="variable">$http_version</span>][<span class="variable">$request_status</span>] += <span class="variable">$response_size</span></span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>by：指定要添加到指标的其他维度，它们将会添加到指标的标签中。<br>每个维度包含在[ ]中。<br>运行mtail程序</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo mtail --progs /etc/mtail --logs <span class="string">&#x27;/var/log/apache/*.access&#x27;</span></span></span><br></pre></td></tr></table></figure>
<h2 id="解析Rail日志到直方图"><a href="#解析Rail日志到直方图" class="headerlink" title="解析Rail日志到直方图"></a>解析Rail日志到直方图</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">counter rails_requests_started_total</span><br><span class="line">counter rails_requests_started by verb</span><br><span class="line">counter rails_requests_completed_total</span><br><span class="line">counter rails_requests_completed by status</span><br><span class="line">counter rails_requests_completed_milliseconds_sum by status</span><br><span class="line">counter rails_requests_completed_milliseconds_count by status</span><br><span class="line">counter rails_requests_completed_milliseconds_bucket by le,status</span><br><span class="line"></span><br><span class="line">/^Started (?P&lt;verb&gt;[A-Z]+) ./*/ &#123;</span><br><span class="line">  rails_requests_started_total++</span><br><span class="line"><span class="meta prompt_">  rails_requests_started[$</span><span class="language-bash">verb]++</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/^Completed (?P&lt;status&gt;\d&#123;3&#125;) .+ in (?P&lt;request_milliseconds&gt;\d+)ms .*$/ &#123;</span><br><span class="line">rails_requests_completed_total++</span><br><span class="line"><span class="meta prompt_">rails_requests_completed[$</span><span class="language-bash">status]++</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">rails_requests_completed_milliseconds_sum[$</span><span class="language-bash">status] += <span class="variable">$request_milliseconds</span></span></span><br><span class="line"><span class="meta prompt_">rails_requests_completed_milliseconds_count[$</span><span class="language-bash">status] ++</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">request_milliseconds &lt;= 10&#123;</span></span><br><span class="line">    rails_requests_completed_milliseconds_bucket[&quot;10&quot;][$status] ++</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">request_milliseconds &lt;= 50&#123;</span></span><br><span class="line">  rails_requests_completed_milliseconds_bucket[&quot;50&quot;][$status] ++</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>尽量为每个应用单独部署日志监控，对于K8S上的应用，可以使用sidecar的方式运行mtail来实现日志监控。<br>例子代码：<a target="_blank" rel="noopener" href="https://github.com/google/mtail/tree/master/examples">https://github.com/google/mtail/tree/master/examples</a></p>
<h1 id="九、探针监控"><a href="#九、探针监控" class="headerlink" title="九、探针监控"></a>九、探针监控</h1><p>使用<a target="_blank" rel="noopener" href="https://github.com/prometheus/blackbox_exporter">Blackbox exporter</a>来对外部服务探测监控。</p>
<ol>
<li>安装Blackbox exporter</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget https://github.com/prometheus/blackbox_exporter/releases/download/v0.16.0/blackbox_exporter-0.16.0.linux-amd64.tar.gz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tar -xzf blackbox_exporter-0.16.0.linux-amd64.tar.gz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">cp</span> blackbox_exporter-0.16.0.linux-amd64/blackbox_exporter /usr/local/bin/</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>配置Blackbox exporter<br>使用&#x2F;etc&#x2F;prober&#x2F;prober.yml文件配置exporter</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">mkdir</span> -p /etc/prober</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">touch</span> /etc/prober/prober.yml</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> &gt; /etc/prober/prober.yml &lt;&lt;<span class="string">EOF</span></span></span><br><span class="line">modules:</span><br><span class="line">  http_2xx_check:</span><br><span class="line">    prober: http</span><br><span class="line">    timeout: 5s</span><br><span class="line">    http:</span><br><span class="line">      valid_status_codes: []</span><br><span class="line">      method: GET</span><br><span class="line">  icmp_check:</span><br><span class="line">    prober: icmp</span><br><span class="line">    timeout: 5s</span><br><span class="line">    icmp:</span><br><span class="line">      preferred_ip_protocol: &quot;ip4&quot;</span><br><span class="line">  dns_examplecom_check:</span><br><span class="line">    prober: dns</span><br><span class="line">    dns:</span><br><span class="line">      preferred_ip_protocol: &quot;ip4&quot;</span><br><span class="line">      query_name: &quot;www.example.com&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>启动exporter</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo blackbox_exporter --config.file=<span class="string">&quot;/etc/prober/prober.yml&quot;</span></span></span><br></pre></td></tr></table></figure>
<p>默认在端口9115下运行服务：<a target="_blank" rel="noopener" href="http://localhost:9115/metrics">http://localhost:9115/metrics</a><br>4. Prometheus创建作业，调用Blackbox Exporter服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &#x27;blackbox&#x27;</span><br><span class="line">    metrics_path: /probe</span><br><span class="line">    params:</span><br><span class="line">      module: [http_2xx_check]  # Look for a HTTP 200 response.</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets:</span><br><span class="line">        - http://prometheus.io    # Target to probe with http.</span><br><span class="line">        - https://prometheus.io   # Target to probe with https.</span><br><span class="line">        - http://example.com:8080 # Target to probe with http on port 8080.</span><br><span class="line">    relabel_configs:</span><br><span class="line">      - source_labels: [__address__]</span><br><span class="line">        target_label: __param_target</span><br><span class="line">      - source_labels: [__param_target]</span><br><span class="line">        target_label: instance</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: 127.0.0.1:9115 </span><br></pre></td></tr></table></figure>
<p>Blackbox Exporter的配置Job方式与其他作业不同，这的targets是作为Blackbox Exporter检测的目标地址。而Blackbox Exporter的服务地址，通过relabel_configs替换掉__address__标签的方式设置。</p>
<h1 id="十、Pushgateway方式推送监控数据"><a href="#十、Pushgateway方式推送监控数据" class="headerlink" title="十、Pushgateway方式推送监控数据"></a>十、Pushgateway方式推送监控数据</h1><p>Prometheus主要是基于拉取的架构来运行作业，同时也提供了Pushgateway服务来支持Push方式。<br>Pushgateway位于发送指标的应用程序与Prometheus服务器之间，接收指标，同时作为目标被抓取。<br>Pushgateway只能用作有限的解决方案使用，特别是监控其他无法访问的资源。</p>
<ol>
<li>安装Pushgateway</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget https://github.com/prometheus/pushgateway/releases/download/v1.0.0/pushgateway-1.0.0.linux-amd64.tar.gz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tar -xzf pushgateway-1.0.0.linux-amd64.tar.gz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">cp</span> pushgateway-1.0.0.linux-amd64/pushgateway /usr/local/bin</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>配置和运行Pushgateway</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pushgateway --web.listen-address=<span class="string">&quot;0.0.0.0:9091&quot;</span> --persistence.file=<span class="string">&quot;/tmp/pushgateway_persist&quot;</span> --persistence.interval=5m</span></span><br></pre></td></tr></table></figure>
<p>–web.listen-address：指定服务端口。pushgateway默认端口是9091.<br> –persistence.file：指标持久化到路径。默认情况下，pushgateway所有指标存储在内存中，如果pushgateway停止服务或者重新启动，所有数据将会丢失。<br>–persistence.interval：指标持久化写入周期。默认5m<br>3. 向pushgateway服务发送指标</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">echo</span> <span class="string">&quot;batchjob1_user_counter 2&quot;</span> | curl --data-binary @- http://localhost:9091/metrics/job/batchjob1/instance/sidekiq_server</span></span><br></pre></td></tr></table></figure>
<p>将为作业batchjob1添加一个新的指标<br><code>batchjob1_user_counter{instance=&quot;sidekiq_server&quot;} 2</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | curl --data-binary @- http://localhost:9091/metrics/job/batchjob1/instance/sidekiq_server</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">TYPE batchjob1_user_counter counter</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">HELP batchjob1_user_counter A metric from BatchJob1.</span></span></span><br><span class="line">batchjob1_user_counter&#123;job_id=&quot;123ABC&quot;&#125; 2</span><br></pre></td></tr></table></figure>
<p>也可以同时发送多个指标。<br>4. 在pushgateway上查看指标</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl http://localhost:9091/metrics</span></span><br></pre></td></tr></table></figure>
<ol start="5">
<li>删除pushgateway上的指标</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -x DELETE localhost:9091/metrics/job/batchjob1 <span class="comment">#删除job batchjob1下的所有指标</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -x DELETE localhost:9091/metrics/job/batchjob1/instance/sidekiq_server <span class="comment"># 删除job batchjob1下标签满足instance=sidekiq_server的指标</span></span></span><br></pre></td></tr></table></figure>
<ol start="6">
<li>Promethes上添加Pushgateway Job</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &#x27;pushgateway&#x27;</span><br><span class="line">    honor_labels: true</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;localhost:9091&#x27;]</span><br></pre></td></tr></table></figure>
<p>honor_labels设置为true，Prometheus使用Pushgateway上的job和instance标签，否则会在前面加上exported_前缀。</p>
<h1 id="十一、监控OpenShift"><a href="#十一、监控OpenShift" class="headerlink" title="十一、监控OpenShift"></a>十一、监控OpenShift</h1><p>OpenShift平台的监控方案默认为Prometheus开源监控方案，它不仅带有一整套完成的监控，而且还预配置了一组告警，以及一组丰富的Grafana仪表盘。</p>
<p><img src="https://img.xhua.eu.org/d07beb395f99d464221c04f52627d4c344ba13170d852b22bef3dda3810c3aaa.jpg" alt="OpenShift Prometheus架构">  </p>
<p>可以通过Prometheus Operator方便地创建、配置和管理Prometheus及Alertmanager。<br>从上图可以看到，除了Prometheus与Alertmanager服务，OpenShift的监控方案中还装了node exporter与kube-state-metrics获取集群的状态指标。<br>OpenShift使用ansible安装时，默认会安装的cluster monitoring operator。除非在inventory中指定openshift_cluster_monitoring_operator_install为false。</p>
<p><img src="https://img.xhua.eu.org/dce9c9a3b49f8064c9296b824a6ff9e393010a8ee99523593753ba8d91cbfc8f.jpg" alt="OpenShift中Prometheus默认监控目标Targets">  </p>
<p><img src="https://img.xhua.eu.org/4ddcd027c0784c7805ea907691df298ce62cfb4279fb38797add0b9162f43a72.jpg" alt="OpenShift中Prometheus默认添加的告警规则">  </p>
<h1 id="扩展资料"><a href="#扩展资料" class="headerlink" title="扩展资料"></a>扩展资料</h1><p><a target="_blank" rel="noopener" href="https://awesome-prometheus-alerts.grep.to/">Awesome Prometheus alerts</a><br><a target="_blank" rel="noopener" href="https://github.com/prometheus-community/helm-charts">Rich Exporter</a><br><a target="_blank" rel="noopener" href="https://github.com/3scale-ops/prometheus-exporter-operator">Exporter Operator</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://xhua.eu.org">Michael Pan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://xhua.eu.org/posts/3ea85377ce64.html">https://xhua.eu.org/posts/3ea85377ce64.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://xhua.eu.org" target="_blank">Michael Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/openshift/">openshift</a><a class="post-meta__tags" href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记</a><a class="post-meta__tags" href="/tags/monitor/">monitor</a></div><div class="post-share"><div class="social-share" data-image="https://img.xhua.eu.org/8a25a774e85f4cee5a52f1b5a1866767ea695e09b6e57370d72b1a7bd0bc7e5f.jpg" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="/pluginsSrc/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="/pluginsSrc/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/3c19c6380d6c.html" title="一条命令解决Kubernetes更改默认的namespace"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">一条命令解决Kubernetes更改默认的namespace</div></div><div class="info-2"><div class="info-item-1"> K8S默认是在default的namespace下，但是很多时候我们是在一个新的namespace下部署应用，每个操作都需要指定namespace，非常不方便。那么有没有办法切换namespce呢？如果可以切换的话，那有没有更简单的办法。 最简单的方式切换namespace，赠送一个方便的脚本可以将它alias到一个新的命令”kubectl ns” 12$  alias kubectl=&#x27;_kubectl_custom()&#123; if [[ &quot;$1&quot; == &quot;project&quot; &amp;&amp; &quot;$2&quot; != &quot;&quot; ]]; then ccontext=`kubectl config current-context`; kubectl config set-context $ccontext --namespace=$2; elif [[ &quot;$1&quot; == &quot;projects&quot; &amp;&amp; &quot;$2&quot; == &quo...</div></div></div></a><a class="pagination-related" href="/posts/3be580fc375b.html" title="oc的常用命令整理"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">oc的常用命令整理</div></div><div class="info-2"><div class="info-item-1"> oc process   oc new-app   oc new-build   oc create imagestream   oc run   oc create -f    oc policy add-role-to-user edit system:serviceaccount:jenkins:jenkins -n dev   oc adm policy add-scc-to-user anyuid -z gitlab -n gitlab   oc new-project   oc set volumes   oc expose   oc start-build   oc rollback   oc rollout   oc rsync   oc rsh   oc set triggers dc&#x2F;flask-app-s2i –remove-all &amp;&amp; oc set triggers dc&#x2F;flask-app-s2i –from-image&#x3D;flask-app-s2i:v1 -c flask-app-s2i &amp;&am...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/e6f145ab3bbb.html" title="Ceph的搭建流程及openshift上使用ceph-rbd实现动态存储"><img class="cover" src="https://img.xhua.eu.org/4328c75cf6fc869f4b312ec595d7c5ea52567c3ba061d57733a7ddb5f01cbf25.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-05-20</div><div class="info-item-2">Ceph的搭建流程及openshift上使用ceph-rbd实现动态存储</div></div><div class="info-2"><div class="info-item-1">Ceph分布式块存储部署机器列表   名称 核数 内存 ip hostname 外挂磁盘大小（G）    管理节点admin 2 4 192.168.1.2 admin.ceph.com    监控节点monitor 2 4 192.168.1.3 monitor.ceph.com    存储节点node1 2 4 192.168.1.4 node1.ceph.com 100G   存储节点node2 2 4 192.168.1.5 node2.ceph.com 100G   部署Ceph RBD 1、给每台机器设置hostname  12345# 设置hostname  hostnamectl --static set-hostname admin.ceph.com   #192.168.1.2 hostnamectl --static set-hostname monitor.ceph.com #192.168.1.3 hostnamectl --static set-hostname node1.ceph.com   #192.168.1.4 hostnamectl --s...</div></div></div></a><a class="pagination-related" href="/posts/c1cb5e8c61ba.html" title="OpenShift灾备的方案及步骤"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-05-20</div><div class="info-item-2">OpenShift灾备的方案及步骤</div></div><div class="info-2"><div class="info-item-1">https://docs.openshift.com/container-platform/3.11/admin_guide&#x2F;assembly_restoring-cluster.htmlhttps://docs.openshift.com/container-platform/3.11/admin_guide&#x2F;assembly_replace-master-host.htmlhttps://docs.openshift.com/container-platform/3.11/admin_guide&#x2F;assembly_restore-etcd-quorum.htmlhttps://docs.openshift.com/container-platform/3.11/admin_guide&#x2F;assembly_replace-etcd-member.html </div></div></div></a><a class="pagination-related" href="/posts/ff93f3dfa6fc.html" title="Openshift集群全环境备份"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-05-20</div><div class="info-item-2">Openshift集群全环境备份</div></div><div class="info-2"><div class="info-item-1"> 创建集群全环境备份非常有必要，特别是在生产过程中。当集群发生异常崩溃，数据丢失时，备份的数据就派上了用场，利用备份数据可以将之前的环境重新构建出来。 在Openshift平台，我们可以对集群的完整状态备份到外部存储。集群全环境包括：  集群数据文件  etcd数据库  Openshift对象配置  私有镜像仓库存储  持久化卷   我们要定期对集群作备份，以防止数据的丢失。 集群全环境备份并不是万能的，应用自己的数据我们应该保证有单独的备份。 创建Master节点备份在系统基础架构进行更改，都需要对节点做备份。比如说，系统升级，集群升级或者任何重大更新。通过定期备份数据，当集群出现故障时，我们就能使用备份恢复集群。 Master主机上运行着非常重要的服务：API、Controllers。&#x2F;etc&#x2F;origin&#x2F;master目录下存放着许多重要的文件。  API、Controllers服务等的配置文件  安装生成的证书  云提供商提供的配置文件  密钥和其它身份认证文件   另外如果有额外自定义的配置，比如更改日志级别，使用代理等。这些配置文件在&#...</div></div></div></a><a class="pagination-related" href="/posts/67c1601a81ee.html" title="OpenShift-如何设置使用Prometheus来监控Router"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-05-20</div><div class="info-item-2">OpenShift-如何设置使用Prometheus来监控Router</div></div><div class="info-2"><div class="info-item-1">OpenShift集群中的Router服务作为几乎所有南北流量的入口非常重要，对它的监控有很大的意义，既能够查看流量的变化，及时发现业务的变化，也可以发现异常请求及时发现问题。 红帽对于Router服务其实已经开启了监控指标的服务，但是默认并没有与Prometheus服务对接，需要手动对接，具体对接的操作如下。  获取Router应用的访问用户名与密码  1234$ oc set env dc/router -n default --list  | grep STATSSTATS_PASSWORD=Oby3Y2FXs5STATS_PORT=1936STATS_USERNAME=admin  在prometheus项目下创建访问Router指标的密钥  1$ oc create secret generic router-auth --from-literal=user=admin --from-literal=password=Oby3Y2FXs5 -n openshift-monitoring  在openshift-monitoring项目下创建ServiceMonitor ...</div></div></div></a><a class="pagination-related" href="/posts/1f94b61afe3b.html" title="Openshift3-9部署手册"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-05-20</div><div class="info-item-2">Openshift3-9部署手册</div></div><div class="info-2"><div class="info-item-1">说明：本文主要介绍通过Ansible来部署Openshift 3.9 一、准备系统准备   节点类型 说明    Masters 物理主机或者虚拟机 系统：Fedora 21, CentOS 7.3, 7.4或者7.5 最少4vCPU最少16GB内存&#x2F;var&#x2F;最少40GB空间 &#x2F;usr&#x2F;local&#x2F;bin最少1GB空间容器临时目录最少1GB空间 &nbsp;   Nodes 物理主机或者虚拟机 系统：Fedora 21, CentOS 7.3, 7.4或者7.5 NetworkManager版本1.0以上最少1vCPU最少8GB内存&#x2F;var&#x2F;最少15GB空间 &#x2F;usr&#x2F;local&#x2F;bin最少1GB空间容器临时目录最少1GB空间 &nbsp;   额外的etcd节点 最少20GB用来存储etcd数据 &nbsp;   注：在安装时可以通过ansible_inventory的配置忽略以上系统要求扩展：对于生产部署时，Master的配置要求计算规则如下：每1000个pods需要额外的1核...</div></div></div></a><a class="pagination-related" href="/posts/83a1dcc308fe.html" title="OpenShift-云原生容器应用设计原则"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-05-20</div><div class="info-item-2">OpenShift-云原生容器应用设计原则</div></div><div class="info-2"><div class="info-item-1"> 引自：容器化应用的设计原则来源自RedHat云原生容器应用设计原则白皮书 本文来自于Red Hat咨询顾问Bilgin Ibryam所编写的一篇白皮书，名为《PRINCIPLES OF CONTAINER-BASED APPLICATION DESIGN》。这篇文章在作者的Blog上发表后，作者的twitter被Kubernetes官方twitter转发。白皮书在Red Hat官网的下载地址：https://www.redhat.com/en/resources/cloud-native-container-design-whitepaper 文本是对这篇文章的学习和整理。  先回顾经典的软件设计原则：   保持简单，愚蠢（KISS） 不要重复自己（DRY） 你不会需要它 （YAGNI） 关注点分离（SoC） Single responsibility, Open&#x2F;closed, Liskov substitution, Interface segregation, Dependency inversion （SOLID）   然后是Red Hat的云原生容器设计原则...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E7%9B%91%E6%8E%A7%E7%AE%80%E4%BB%8B"><span class="toc-text">一、监控简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7%E6%A8%A1%E5%BC%8F"><span class="toc-text">监控模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7%E6%9C%BA%E5%88%B6"><span class="toc-text">监控机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-text">监控数据类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7%E6%96%B9%E6%B3%95%E8%AE%BA"><span class="toc-text">监控方法论</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E7%9F%A5%E7%B3%BB%E7%BB%9F"><span class="toc-text">通知系统</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81Prometheus%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-text">二、Prometheus是什么？</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Prometheus%E6%9E%B6%E6%9E%84"><span class="toc-text">Prometheus架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A"><span class="toc-text">名词解释</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-text">监控资源服务发现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%81%9A%E5%90%88%E5%92%8C%E8%AD%A6%E6%8A%A5"><span class="toc-text">聚合和警报</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E3%80%81%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="toc-text">查询、可视化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%97%E4%BD%99%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7"><span class="toc-text">冗余和高可用性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Prometheus%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-text">Prometheus数据模型</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2Prometheus"><span class="toc-text">三、安装部署Prometheus</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Prometheus"><span class="toc-text">安装Prometheus</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux%E4%B8%8A%E5%AE%89%E8%A3%85Prometheus"><span class="toc-text">Linux上安装Prometheus</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ansible%E5%AE%89%E8%A3%85Promethues"><span class="toc-text">Ansible安装Promethues</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OpenShift%E4%B8%8A%E5%AE%89%E8%A3%85Prometheus"><span class="toc-text">OpenShift上安装Prometheus</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEPrometheus"><span class="toc-text">配置Prometheus</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8CPrometheus"><span class="toc-text">运行Prometheus</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE"><span class="toc-text">查询数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%B9%E9%87%8F%E8%A7%84%E5%88%92"><span class="toc-text">容量规划</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E7%9B%91%E6%8E%A7%E4%B8%BB%E6%9C%BA%E5%92%8C%E5%AE%B9%E5%99%A8"><span class="toc-text">四、监控主机和容器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7%E4%B8%BB%E6%9C%BA"><span class="toc-text">监控主机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7Docker%E5%AE%B9%E5%99%A8"><span class="toc-text">监控Docker容器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prometheus%E6%8A%93%E5%8F%96%E6%95%B0%E6%8D%AE%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-text">Prometheus抓取数据的生命周期</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%87%E7%AD%BE"><span class="toc-text">标签</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Node-Exporter%E5%92%8CcAdvisor%E6%8C%87%E6%A0%87"><span class="toc-text">Node Exporter和cAdvisor指标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-text">查询持久化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E8%A7%86%E5%8C%96-Grafana"><span class="toc-text">可视化 Grafana</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81Prometheus%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-text">五、Prometheus服务发现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E6%96%87%E4%BB%B6%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-text">基于文件的服务发现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8EAPI%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-text">基于API的服务发现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8EDNS%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-text">基于DNS的服务发现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%E3%80%81Alert-Manager%E6%8A%A5%E8%AD%A6%E7%AE%A1%E7%90%86"><span class="toc-text">六、Alert Manager报警管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Alertmanager%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C"><span class="toc-text">Alertmanager如何工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Alertmanager%E5%AE%89%E8%A3%85%E3%80%81%E9%85%8D%E7%BD%AE%E3%80%81%E8%BF%90%E8%A1%8C"><span class="toc-text">Alertmanager安装、配置、运行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prometheus%E9%85%8D%E7%BD%AEAlertmanager"><span class="toc-text">Prometheus配置Alertmanager</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1"><span class="toc-text">路由</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E7%9F%A5%E6%A8%A1%E6%9D%BF"><span class="toc-text">通知模板</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#silence%E5%92%8C%E7%BB%B4%E6%8A%A4"><span class="toc-text">silence和维护</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%83%E3%80%81Prometheus%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7"><span class="toc-text">七、Prometheus高可用性</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AEAlertmanager%E9%9B%86%E7%BE%A4"><span class="toc-text">设置Alertmanager集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E6%89%A9%E5%B1%95%E6%80%A7"><span class="toc-text">可扩展性</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E6%97%A5%E5%BF%97%E7%9B%91%E6%8E%A7"><span class="toc-text">八、日志监控</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%84%E7%90%86Web%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AE%BF%E9%97%AE%E6%97%A5%E5%BF%97"><span class="toc-text">处理Web服务器访问日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90Rail%E6%97%A5%E5%BF%97%E5%88%B0%E7%9B%B4%E6%96%B9%E5%9B%BE"><span class="toc-text">解析Rail日志到直方图</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B9%9D%E3%80%81%E6%8E%A2%E9%92%88%E7%9B%91%E6%8E%A7"><span class="toc-text">九、探针监控</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E3%80%81Pushgateway%E6%96%B9%E5%BC%8F%E6%8E%A8%E9%80%81%E7%9B%91%E6%8E%A7%E6%95%B0%E6%8D%AE"><span class="toc-text">十、Pushgateway方式推送监控数据</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%B8%80%E3%80%81%E7%9B%91%E6%8E%A7OpenShift"><span class="toc-text">十一、监控OpenShift</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E8%B5%84%E6%96%99"><span class="toc-text">扩展资料</span></a></li></ol></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2023 - 2026 By Michael Pan</span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden="hidden"></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="local-search-input"><input placeholder="搜索文章" type="text"/></div><hr/><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none;"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>